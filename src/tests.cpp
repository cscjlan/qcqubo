#include <cstdio>
#include <cstring>
#include <fstream>
#include <iostream>
#include <numeric>
#include <random>
#include <span>
#include <sstream>
#include <string>

#include "gpu.hpp"
#include "qubo.hpp"

namespace testing {
struct CPUMem {
    static void *allocate(size_t num_bytes) { return std::malloc(num_bytes); }

    static void free(void *ptr) { std::free(ptr); }

    static void memcpy(void *dst, const void *src, size_t num_bytes) {
        std::memcpy(dst, src, num_bytes);
    }
};

template <typename T, typename Mem>
SparseMatrix<T, Mem> fromDense(const std::vector<T> &dense, uint32_t num_rows) {
    assert(dense.size() == num_rows * num_rows);
    std::vector<uint32_t> indptr{};
    std::vector<uint32_t> indices{};
    std::vector<T> data{};
    const uint32_t num_cols = num_rows;

    indptr.push_back(0);
    for (auto row = 0; row < num_rows; row++) {
        for (auto col = 0; col < num_cols; col++) {
            const auto index = row * num_cols + col;
            const auto value = dense[index];
            if (value != 0.0) {
                data.push_back(value);
                indices.push_back(col);
            }
        }
        const auto end = data.size();
        indptr.push_back(end);
    }

    assert(indptr.size() == num_rows + 1);

    return SparseMatrix<T, Mem>(indptr, indices, data);
}

void testAllocator() {
    std::printf("Testing allocator\n");

    auto testAlignment = [](auto *ptr) {
        auto addr = reinterpret_cast<std::intptr_t>(ptr);
        using T = std::remove_cvref_t<decltype(*ptr)>;
        auto misalign = addr & (alignof(T) - 1);
        std::printf("%lu, %ld, %ld\n", alignof(T), addr, misalign);
        return misalign == 0ul;
    };

    uint8_t dummyb = 0;
    float dummyf = 0.0f;
    double dummyd = 0.0;
    assert(testAlignment(&dummyb));
    assert(testAlignment(&dummyf));
    assert(testAlignment(&dummyd));

    std::vector<uint8_t> data(1024, 0);
    assert(testAlignment(data.data()));

    Allocator allocator(data.data(), data.size());

    auto *bytes = allocator.allocate<uint8_t>(3);
    assert(bytes == data.data());
    assert(testAlignment(bytes));
    assert(allocator.allocated_bytes() == 3ul);

    // One byte needed for alignment
    auto *floats = allocator.allocate<float>(4);
    assert(static_cast<void *>(floats) == data.data() + 4ul);
    assert(testAlignment(floats));
    assert(allocator.allocated_bytes() == 20ul);

    // Four bytes needed for alignment
    auto *doubles = allocator.allocate<double>(3);
    assert(static_cast<void *>(doubles) == data.data() + 24ul);
    assert(testAlignment(doubles));
    assert(allocator.allocated_bytes() == 48ul);
}

void testSearchDataWithRows() {
    std::printf("Testing SearchData\n");

    static constexpr size_t len_data = 10000;
    static constexpr size_t len_scratch = 16;
    using T = float;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(len_data, len_scratch), 0);
    // This should be the memory requirement
    static constexpr size_t req =
        alignof(S) + sizeof(S) +
        2 * BitVector::requiredLength(len_data) * sizeof(uint32_t) +
        len_data * sizeof(T) + len_scratch * (sizeof(T) + sizeof(uint32_t));

    std::printf("Bytes required for search data: %lu, estimated: %lu\n",
                data.size(), req);
    assert(req == data.size());

    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, len_data, len_scratch);
    assert(allocator.allocated_bytes() <= data.size());

    assert(s->candidate.data() != nullptr);
    assert(s->best_candidate.data() != nullptr);
    assert(s->rows != nullptr);
    assert(s->scratch_values != nullptr);
    assert(s->scratch_indices != nullptr);
    assert(s->len_data == len_data);
    assert(s->len_scratch == len_scratch);

    for (auto i = 0; i < s->len_data; i++) {
        if ((i & 1) == 0) {
            s->candidate.flip(i);
        } else {
            s->best_candidate.flip(i);
        }
        s->rows[i] = static_cast<float>(i);
    }

    for (auto i = 0; i < s->len_scratch; i++) {
        s->scratch_values[i] = static_cast<float>(s->len_data + i);
        s->scratch_indices[i] = 0xBEEFBEEF;
    }

    // assert that all the values are the same as set before:
    // if they're different, there's some overlap between the pointers
    for (auto i = 0; i < s->len_data; i++) {
        if ((i & 1) == 0) {
            assert(s->candidate[i] == 1);
            assert(s->best_candidate[i] == 0);
        } else {
            assert(s->candidate[i] == 0);
            assert(s->best_candidate[i] == 1);
        }
        assert(s->rows[i] == static_cast<float>(i));
    }

    for (auto i = 0; i < s->len_scratch; i++) {
        assert(s->scratch_values[i] == static_cast<float>(s->len_data + i));
        assert(s->scratch_indices[i] == 0xBEEFBEEF);
    }
}

void testSearchDataWithoutRows() {
    std::printf("Testing SearchData without allocating rows\n");
    static constexpr size_t len_data = 10000;
    static constexpr size_t len_scratch = 16;
    using T = float;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(len_data, len_scratch, false), 0);
    std::vector<T> rows(len_data, 0);
    // This should be the memory requirement
    static constexpr size_t req =
        alignof(S) + sizeof(S) +
        2 * BitVector::requiredLength(len_data) * sizeof(uint32_t) +
        len_scratch * (sizeof(T) + sizeof(uint32_t));

    std::printf("Bytes required for search data: %lu, estimated: %lu\n",
                data.size(), req);
    assert(req == data.size());

    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, len_data, len_scratch, rows.data());
    assert(allocator.allocated_bytes() <= data.size());

    assert(s->candidate.data() != nullptr);
    assert(s->best_candidate.data() != nullptr);
    assert(s->rows == rows.data());
    assert(s->scratch_values != nullptr);
    assert(s->scratch_indices != nullptr);
    assert(s->len_data == len_data);
    assert(s->len_scratch == len_scratch);

    for (auto i = 0; i < s->len_data; i++) {
        if ((i & 1) == 0) {
            s->candidate.flip(i);
        } else {
            s->best_candidate.flip(i);
        }
        s->rows[i] = static_cast<float>(i);
    }

    for (auto i = 0; i < s->len_scratch; i++) {
        s->scratch_values[i] = static_cast<float>(s->len_data + i);
        s->scratch_indices[i] = 0xBEEFBEEF;
    }

    // assert that all the values are the same as set before:
    // if they're different, there's some overlap between the pointers
    for (auto i = 0; i < s->len_data; i++) {
        if ((i & 1) == 0) {
            assert(s->candidate[i] == 1);
            assert(s->best_candidate[i] == 0);
        } else {
            assert(s->candidate[i] == 0);
            assert(s->best_candidate[i] == 1);
        }
        assert(s->rows[i] == static_cast<float>(i));
    }

    for (auto i = 0; i < s->len_scratch; i++) {
        assert(s->scratch_values[i] == static_cast<float>(s->len_data + i));
        assert(s->scratch_indices[i] == 0xBEEFBEEF);
    }
}

void testFromToDense() {
    std::printf("Testing fromDense\n");
    static constexpr uint32_t num_rows = 4;

    std::vector<float> dense{
        11.0f, 0.0f,  0.0f,  0.0f, 21.0f, 22.0f, 0.0f, 0.0f,
        0.0f,  32.0f, 33.0f, 0.0f, 0.0f,  0.0f,  0.0f, 44.0f,
    };

    const auto sparse = fromDense<float, CPUMem>(dense, num_rows);
    const auto m = sparse.getView();

    assert(m.shape().first == num_rows);
    assert(m.shape().second == num_rows);

    auto row = m.diagonal;
    assert(row[0] == 11.0f);
    assert(row[1] == 22.0f);
    assert(row[2] == 33.0f);
    assert(row[3] == 44.0f);

    row = m.rowData(0);
    assert(row[0] == 11.0f);
    assert(row.size() == 1);

    auto ind = m.rowIndices(0);
    assert(ind[0] == 0);
    assert(ind.size() == 1);

    row = m.rowData(1);
    assert(row[0] == 21.0f);
    assert(row[1] == 22.0f);
    assert(row.size() == 2);

    ind = m.rowIndices(1);
    assert(ind[0] == 0);
    assert(ind[1] == 1);
    assert(ind.size() == 2);

    row = m.rowData(2);
    assert(row[0] == 32.0f);
    assert(row[1] == 33.0f);
    assert(row.size() == 2);

    ind = m.rowIndices(2);
    assert(ind[0] == 1);
    assert(ind[1] == 2);
    assert(ind.size() == 2);

    row = m.rowData(3);
    assert(row[0] == 44.0f);
    assert(row.size() == 1);

    ind = m.rowIndices(3);
    assert(ind[0] == 3);
    assert(ind.size() == 1);

    const auto td = m.toDense();
    assert(td.size() == dense.size());
    for (auto i = 0; i < td.size(); i++) {
        assert(td[i] == dense[i]);
    }
}

void testBitVector() {
    std::printf("Testing bitVector\n");
    uint32_t len = 100;
    const auto reql = BitVector::requiredLength(len);
    assert(reql == len / 32 + 1);
    std::vector<uint32_t> data(reql, 0);

    BitVector bv(data.data());
    for (auto i = 0; i < len; i++) {
        assert(bv[i] == 0u);
    }

    bv.flip(10);
    assert(bv[9] == 0u);
    assert(bv[10] == 1u);
    assert(bv[11] == 0u);
    bv.flip(10);

    for (auto i = 0; i < len; i++) {
        bv.flip(i);
    }

    // The last may not be entirely ones, as the length of the bit vector might
    // not be divisible by 32
    auto last = bv.data()[reql - 1];
    assert(last == (~0u) << (32 - (len % 32)));
    for (auto i = 0; i < reql - 1; i++) {
        assert(bv.data()[i] == ~0u);
    }

    for (auto i = 0; i < 32; i++) {
        assert(BitVector::bitIdx(i) == 31 - i);
        assert(BitVector::dataIdx(i) == 0);
    }
}

void testSuperspan() {
    std::printf("Testing superspan\n");

    const uint32_t num_subspans = 20;
    const uint32_t subspan_len = 58;
    const auto reql =
        SuperSpan<double>::requiredLength(num_subspans, subspan_len);
    std::vector<double> data(reql, 0);
    auto ss = SuperSpan<double>(std::span(data), num_subspans, subspan_len);

    assert(ss.subspanLength() == subspan_len);

    for (auto &v : ss.subspan(0)) {
        v = 1.0;
    }

    for (auto &v : ss.subspan(1)) {
        v = 2.0;
    }

    // There's padding between the subspans that should be zero
    for (auto i = 0; i < 128; i++) {
        if (i < subspan_len) {
            assert(data[i] == 1.0);
        } else if (i < 64) {
            assert(data[i] == 0.0);
        } else if (i < subspan_len + 64) {
            assert(data[i] == 2.0);
        } else {
            assert(data[i] == 0.0);
        }
    }
}

void testSuperspan2() {
    std::printf("Testing superspan2\n");

    const uint32_t num_subspans = 5;
    const uint32_t subspan_len = 96;
    const auto reql =
        SuperSpan<double>::requiredLength(num_subspans, subspan_len);
    std::vector<double> data(reql, 0);
    auto ss = SuperSpan<double>(std::span(data), num_subspans, subspan_len);

    assert(ss.subspanLength() == subspan_len);

    for (auto &v : ss.subspan(0)) {
        v = 1.0;
    }

    for (auto &v : ss.subspan(1)) {
        v = 2.0;
    }

    // There shouldn't be any padding between the subspans
    for (auto i = 0; i < 192; i++) {
        if (i < subspan_len) {
            assert(data[i] == 1.0);
        } else {
            assert(data[i] == 2.0);
        }
    }
    assert(data[192] == 0.0);
}

void testmx1() {
    std::printf("Testing mx\n");

    static constexpr size_t len_data = 4;
    static constexpr size_t len_scratch = 1;
    using T = float;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(len_data, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, len_data, len_scratch);

    std::vector<float> dense{
        11.0f, 0.0f,  0.0f,  0.0f, 21.0f, 22.0f, 0.0f, 0.0f,
        0.0f,  32.0f, 33.0f, 0.0f, 0.0f,  0.0f,  0.0f, 44.0f,
    };

    const auto sparse = fromDense<float, CPUMem>(dense, len_data);
    const auto m = sparse.getView();

    s->candidate.data()[0] = ~0u;

    mx(m, s);
    assert(s->rows[0] == 11.0f);
    assert(s->rows[1] == 21.0f + 22.0f);
    assert(s->rows[2] == 32.0f + 33.0f);
    assert(s->rows[3] == 44.0f);
}

void testmx2() {
    std::printf("Testing mx with random vector\n");

    static constexpr uint32_t num_rows = 32;

    // Random generated with numpy
    std::vector<double> dense{
        5.942730528399744472e-01, 9.875144260995037948e-01,
        4.575020511455630823e-01, 9.380138253712834162e-01,
        7.222402599278143764e-02, 7.050212689137327349e-01,
        6.004864443043294031e-01, 6.515136426536559666e-01,
        7.947410056073709317e-01, 3.419866234447427322e-01,
        1.728545352417776293e-01, 9.477429470539260326e-01,
        4.851046620824734923e-01, 6.539225110186819290e-02,
        8.501734720507079235e-01, 9.668594141221634741e-01,
        6.192165706729139130e-01, 4.918500129042836511e-01,
        9.493186767131606141e-01, 4.289288646776009406e-01,
        4.928632196365601015e-01, 7.886729815330029147e-01,
        2.367279073673955736e-02, 9.286913461456337560e-01,
        6.750138523631283860e-01, 1.120927692534001707e-01,
        3.223594884004248318e-01, 8.472960838110833448e-01,
        4.846366927343890296e-01, 6.758371180436235637e-01,
        7.625743333377607014e-01, 7.634781857967354313e-01,
        1.279545987855956746e-03, 8.839765516369791909e-01,
        1.484926935489754296e-01, 7.962544024475249893e-01,
        6.743155692783523447e-01, 4.526335978775087865e-01,
        2.097220770415760827e-01, 6.756258837978588172e-01,
        1.763406104366000982e-01, 3.177740533657688049e-01,
        2.073687418585632436e-01, 9.599398218901459279e-01,
        3.277301762223339132e-01, 8.556176756041580234e-01,
        9.011148123304094648e-01, 9.880405148514163072e-01,
        3.765154987954442145e-01, 5.905980355254163428e-01,
        4.502409444242849723e-03, 1.133999501219097317e-01,
        9.287205439837853405e-01, 8.336046319212697675e-02,
        2.932149045963944323e-01, 2.558195051530322006e-01,
        8.087635919030630172e-01, 2.710648334789219627e-01,
        8.204556270008805940e-01, 8.274490134179883771e-01,
        1.817601716726926497e-01, 2.081317364925416857e-01,
        7.849071986479934093e-01, 3.114705045060590649e-01,
        4.326674875599766379e-01, 8.442034593999775405e-01,
        8.568883185702296235e-01, 1.439069995894445286e-01,
        2.376641834638746342e-01, 8.128616178243472934e-01,
        7.030769303856088115e-02, 6.678769740146215383e-01,
        2.849389764973920824e-01, 8.986137980575632511e-01,
        4.513410991976543052e-01, 1.844674347518755475e-01,
        8.869937029784513705e-01, 7.376027916932792472e-02,
        2.967557452299988130e-01, 9.058230301842962184e-02,
        8.788896062378868113e-01, 4.651201064827558129e-01,
        1.057248316897683171e-01, 9.219749309753576538e-01,
        4.522940881669490487e-01, 4.059090257441504423e-01,
        7.436571439097622305e-01, 2.938775551413830289e-01,
        1.189822881960587164e-01, 7.132460913792106894e-01,
        6.206669303700701468e-01, 3.105555503702260856e-01,
        1.150885248842712372e-01, 3.824578421414118745e-01,
        1.974776928578358959e-01, 5.647689375676059331e-01,
        8.155161228041584165e-01, 6.825769948801496678e-02,
        6.269649504068829371e-01, 8.749737745763492835e-01,
        3.202305193089871604e-02, 1.427991701899493648e-01,
        5.468938479838238997e-01, 4.619655888344407213e-01,
        7.968206377849286204e-01, 7.396206555561438689e-01,
        1.588516994400062110e-01, 3.824630536652832147e-01,
        5.446818307783194424e-01, 9.494347503275530897e-01,
        5.375385334727380560e-01, 6.701379716620611271e-01,
        6.764754131433891038e-01, 5.910127631955419680e-02,
        9.074448362818455793e-01, 2.540679046438186761e-01,
        4.161635936871439512e-01, 7.657314364370992887e-02,
        7.457214913878150719e-01, 2.101891938576956331e-01,
        2.937941485046807744e-01, 8.570192211482940969e-02,
        2.111491892896795175e-01, 1.797293943458249110e-01,
        6.923049347967358269e-01, 5.047917879756904647e-01,
        4.273922073460380000e-01, 2.738359390446839514e-01,
        7.386427401195856390e-01, 5.039757262754884781e-01,
        7.942120469180401487e-01, 6.144047967478220018e-01,
        9.322317712421887004e-01, 4.477651388050269965e-01,
        2.347885171164763030e-01, 7.073674944382168928e-02,
        1.549697565786035680e-01, 8.847608955558928789e-01,
        3.812478902962690430e-01, 6.146089437183260840e-01,
        2.446964813181237153e-01, 9.464575473925542770e-01,
        9.262746321343868772e-01, 9.662942273241846847e-01,
        3.776443532487578914e-01, 7.561013504057800816e-03,
        6.939248454345557926e-01, 8.110656870567857224e-01,
        1.635491083544170499e-01, 3.160997490172896551e-01,
        1.278427202002908603e-01, 6.045366064247151838e-01,
        4.949773473291748660e-01, 5.302273175076942513e-01,
        9.321631839413890841e-02, 2.607417656393870020e-01,
        9.690434736120205894e-01, 3.538554002671485677e-01,
        5.149985414847013665e-03, 8.451003596138129126e-02,
        2.948232967884918398e-01, 2.557864430715958148e-01,
        9.417432012779162198e-01, 7.196452030652141785e-01,
        8.097945585284751502e-01, 4.379990663199319068e-01,
        6.739257457800692519e-01, 6.957013079751255269e-01,
        8.988580828592175331e-01, 5.464706826423229025e-01,
        4.124920641175824354e-01, 1.395940573565983556e-01,
        2.347410407443514258e-01, 2.658768610578202685e-01,
        9.040826413230914627e-01, 3.414451484132740022e-01,
        2.595553706366010571e-01, 7.762183065804527660e-01,
        2.930034258027792715e-01, 9.619877497824347312e-01,
        7.899013015190119447e-01, 5.252928009519298724e-01,
        3.416305148611135101e-01, 8.294820914753870955e-01,
        9.500331363357593650e-01, 5.572401953667233121e-01,
        3.378495107027859046e-01, 3.597705358962283162e-01,
        5.729690909706874891e-02, 2.148341187676695574e-01,
        9.870660918500364645e-01, 2.109130990931862293e-02,
        1.648766266907856215e-01, 2.929030297437010821e-01,
        1.831785633285000214e-01, 6.945267377486518123e-01,
        8.835503662371961831e-01, 7.005514191605023422e-01,
        3.749244706947130190e-01, 5.470245491162317730e-02,
        4.062671044748114024e-01, 4.633679225551705638e-01,
        4.415124573277738884e-01, 5.757552387493376500e-01,
        9.350376755397189488e-01, 9.832404619045375105e-01,
        3.154350874304188146e-01, 1.306312665929236783e-01,
        8.979920777144662081e-01, 7.419235364105136732e-01,
        1.320833050993243107e-01, 8.257191912487399366e-01,
        5.566174413559044076e-01, 4.915993556501755402e-01,
        5.869566292185114387e-01, 5.112162775125528302e-01,
        8.426023789293557442e-02, 2.129553576140749138e-01,
        7.612659580252689739e-01, 7.585920359478756092e-01,
        1.746879990583444231e-01, 6.400558435043638417e-01,
        6.496088964762934959e-01, 3.878859992350214281e-02,
        1.663077399591073036e-02, 4.817063798464956692e-01,
        2.067001250236082388e-01, 8.238834559532363100e-01,
        1.773194397412257706e-01, 9.630816975122220569e-01,
        9.298342901413891859e-01, 5.736814547993476232e-01,
        3.981877139681311295e-02, 6.614825895199203387e-01,
        3.846057296574215689e-01, 9.840299626957809132e-01,
        8.415922534346002015e-01, 2.088733837878451460e-01,
        2.447562015646287392e-01, 1.152130251135897732e-01,
        1.448882752807661989e-01, 7.410370957535682424e-01,
        3.956068777019715599e-01, 5.062419129713946475e-03,
        3.358168900761384634e-01, 7.121366589385585977e-01,
        4.716422286530530528e-02, 3.789923949421356575e-01,
        3.986522271997643418e-01, 5.067969238060421322e-02,
        2.226176593316098185e-01, 9.259429316975416047e-01,
        9.390441800289773822e-01, 9.301672693433540307e-01,
        9.753597801178672810e-01, 9.145664249174709770e-01,
        4.611783490424720133e-01, 8.517209136786746404e-01,
        8.140566544990205378e-01, 7.075387007638083148e-01,
        2.085844432514472047e-04, 4.855955094669326400e-01,
        6.433452879197003593e-01, 2.726664759447077202e-01,
        8.982539211291831194e-01, 5.464987615263462439e-01,
        1.878180694171357468e-01, 4.216681477707795445e-02,
        2.046104354479189036e-01, 8.492434357937400646e-01,
        4.794472958643365423e-01, 8.997950085249281083e-01,
        4.841363940141081290e-01, 4.635760061657617781e-01,
        6.664988183739700700e-01, 4.366274508763047235e-01,
        5.958522636869693079e-01, 3.993836246050741501e-02,
        9.077519031832403940e-02, 8.158574462696833729e-01,
        7.440838348465632635e-01, 3.407745820113313728e-01,
        7.989972452836391348e-03, 8.835470148076000063e-01,
        1.029490749490759027e-01, 7.308729562447251471e-01,
        2.476678350301358966e-01, 1.919353680712757582e-01,
        1.083233423895146874e-01, 1.926695298049206917e-01,
        5.242511419873938650e-01, 4.632280236677996932e-01,
        5.825418900515455523e-01, 3.562791045395264922e-01,
        9.369491694224625356e-01, 3.419094792638583957e-01,
        3.345753317698937357e-01, 9.115625979886382568e-01,
        1.180681903008573563e-01, 8.033446732345267405e-01,
        3.217830672998663877e-01, 4.131530171267807638e-01,
        5.241565913715334757e-01, 7.579102851609877955e-01,
        6.174304429879962086e-01, 9.721646326386503834e-01,
        9.425510231237841374e-01, 7.831696352092540891e-01,
        4.490782510760222834e-01, 8.080758320712678744e-01,
        6.614652228688325808e-01, 8.822950807979601517e-02,
        5.060535418439936484e-01, 8.111020625470711787e-01,
        6.842625505242238004e-01, 8.490094049506613505e-02,
        9.024962845885661222e-01, 1.840111995379718479e-01,
        2.310172009764139833e-01, 3.807931476332848675e-04,
        2.244545536035369437e-01, 7.363828025309933079e-01,
        7.466763832438777504e-01, 1.340803158907306614e-01,
        1.734239112379543091e-01, 9.944403581894633026e-01,
        7.036902452446881506e-01, 4.158223036392671990e-02,
        4.933151528404622344e-02, 6.113433374578686186e-01,
        2.909342658715992069e-01, 1.745931168306835701e-01,
        6.206666641756353187e-02, 2.907640221671778935e-01,
        2.364425869008930370e-01, 6.540804867558894786e-01,
        3.402720563393079045e-01, 3.613807341912556037e-01,
        8.169919811446716418e-01, 4.870260929075761469e-01,
        6.425742933361305864e-01, 4.436722633280587580e-01,
        2.220723867146658925e-01, 8.759979499392478441e-02,
        9.454563300809679660e-01, 5.610859233298063353e-01,
        8.091670842364259153e-01, 3.658002744992265853e-01,
        3.075766873851988326e-01, 7.685188121067684230e-01,
        1.526091273684353489e-01, 6.576784688419823333e-03,
        9.238064670215846430e-01, 3.449261622477067801e-01,
        2.986387243345181020e-01, 5.422675574292227241e-01,
        1.739400087465015066e-02, 1.847809793667478662e-01,
        4.092647089251431058e-01, 2.090276218694850918e-01,
        8.351048239731515554e-01, 9.800304616213698639e-01,
        8.890892590147422281e-01, 8.452350856735054707e-01,
        3.292629989819029213e-02, 5.718526895398651222e-01,
        6.257874561824022797e-01, 1.512351657101695945e-02,
        7.746675208513176258e-01, 1.625014669900802788e-01,
        1.225723425519487098e-02, 7.782784800749509291e-02,
        5.746187961215920570e-01, 3.138676379453750886e-01,
        5.530678583453744190e-01, 3.046008117622962530e-01,
        1.543265046424036058e-01, 5.520791709780412670e-01,
        5.916360576934186488e-01, 1.552199091022405941e-01,
        6.946473492514061432e-01, 8.234326931987214770e-01,
        8.377562289495281700e-01, 8.293169234973235548e-01,
        7.801633620837046257e-01, 8.942984193498098033e-01,
        4.208366521044805131e-01, 1.668525120408839157e-01,
        8.498083165308158993e-01, 2.507619664087601397e-02,
        4.661184212523101777e-01, 1.117135414609086164e-01,
        9.749264764977483289e-01, 9.720038108819162304e-02,
        1.730880148809373908e-01, 4.633101654623605903e-02,
        5.101887555650711503e-01, 7.043746175171899937e-01,
        1.584161827365649922e-01, 6.711035342811141335e-01,
        6.157675251506726788e-01, 1.518308827276231288e-01,
        9.102582177145760456e-01, 4.200413732913025333e-01,
        4.648179961759091317e-02, 4.197901448357905796e-01,
        9.765754911297267471e-01, 8.761143223621451481e-01,
        6.083436019098250602e-01, 7.907412698266624851e-01,
        6.616741824065480726e-01, 6.684791137359172852e-01,
        7.647677675215275306e-01, 4.915783773893361852e-01,
        6.613732323636795085e-01, 9.060623235710072443e-01,
        5.968770950019577359e-01, 8.049382556759169249e-01,
        3.044388248908869166e-02, 2.718450591480885414e-01,
        6.223255550846261697e-01, 5.853535996426185717e-01,
        1.146317351188590461e-01, 3.362241647007466749e-01,
        5.389984986320051075e-02, 4.558677675354905201e-01,
        1.368961566583761780e-01, 5.028428086767566807e-01,
        9.733545711741277140e-01, 5.332373658681816009e-01,
        5.106528245139601019e-01, 9.779313856993918641e-01,
        7.509423270350263913e-01, 3.390877728536600966e-01,
        2.284471907281060421e-02, 8.437580534904072227e-01,
        1.086447981783840167e-01, 2.593147564172881836e-01,
        8.748623298394000436e-01, 1.151339618698521416e-02,
        6.369215811064170563e-01, 9.573704979619650501e-01,
        2.006396328715605026e-01, 2.699391677455339478e-01,
        9.065811580421141436e-01, 6.318360371389664110e-02,
        8.626860338713432386e-01, 4.642444267356689025e-01,
        4.026417975161559193e-01, 9.413376864771760832e-02,
        2.033545932274773982e-01, 8.438428795243906322e-01,
        4.291008815221144523e-01, 9.805367564625057097e-01,
        6.794553433618896188e-01, 2.169793807478477277e-01,
        8.421763783347961940e-01, 2.959472682647512620e-03,
        7.422649532920925219e-01, 9.647859351430571051e-01,
        1.187241599557927740e-01, 8.064115545311838495e-01,
        9.464544860108432545e-01, 7.049560023638149486e-01,
        2.365433486690842191e-01, 4.291362928682611599e-01,
        6.670155874507810445e-03, 5.676225516168307283e-01,
        2.079704633473390407e-01, 4.795730889929841201e-01,
        7.880634735713375472e-01, 6.045456997371290164e-02,
        8.396582533305559926e-01, 2.835939939783537200e-01,
        9.819416714520667888e-02, 5.439598787523203249e-03,
        5.656508204459903544e-01, 2.271859316035608201e-01,
        8.541750465765067801e-01, 3.121798715492309917e-01,
        9.781069947382440288e-01, 3.190367859290133001e-01,
        4.846101742613172503e-01, 7.287517917921393362e-02,
        7.378949457240923104e-01, 5.851941470571335735e-01,
        6.067676707073101916e-01, 5.866052411268778410e-01,
        8.511751862413317049e-01, 5.887416214198230024e-01,
        9.176909607231482635e-01, 1.770236554160382614e-01,
        9.156748676233286144e-01, 1.716989142639139265e-01,
        3.102466642534031926e-01, 1.808347239226427705e-01,
        5.706150316608155082e-01, 7.725926368510680486e-01,
        1.531652736300944673e-01, 2.117254171140304786e-01,
        4.185533390168485468e-01, 7.573557493903103621e-01,
        3.885060015622080476e-01, 2.737933526824477548e-01,
        3.180205311212035424e-01, 7.190209951295456481e-02,
        7.179005384426908609e-01, 5.721862633050653901e-01,
        2.661224366107558525e-01, 5.765159828567090194e-01,
        3.808860911298082019e-01, 9.544550646801308602e-02,
        6.402220649995472579e-01, 9.025266577415512748e-01,
        7.729382991233287870e-01, 1.025658703341379985e-01,
        9.324539134812916963e-01, 4.061796295345512231e-01,
        4.548942836612352991e-01, 9.636572205808408009e-01,
        1.393802320985177978e-01, 5.968228641467546725e-01,
        5.148077935724107990e-01, 1.809052618891029418e-01,
        1.198150135095998881e-01, 7.432731636497743599e-01,
        4.611105737033963647e-01, 2.854718186826921134e-03,
        1.917099615992804429e-01, 9.582630597246081239e-01,
        2.147790419229678172e-01, 9.313747783174288752e-01,
        9.639307709719960870e-01, 9.586048094936832076e-01,
        7.045264009148843876e-01, 5.586305870690728703e-01,
        5.656986077350441011e-01, 3.300052292428100609e-01,
        4.743986223860405804e-01, 1.896134806847127319e-02,
        7.073299180849251799e-01, 7.274554778410002864e-02,
        8.137491582167455384e-02, 6.583740028922812071e-01,
        7.507157077014763313e-01, 6.617409428364827706e-01,
        5.695104983972666401e-01, 1.437320380704900646e-01,
        1.505937282528030385e-01, 2.609138345518638991e-01,
        5.073161388884321887e-01, 5.368225632591194785e-02,
        3.575414834855272783e-01, 5.695482085767441527e-01,
        3.714651607903408648e-01, 9.344412363952177003e-01,
        9.064760718120460359e-01, 2.333594292335087195e-01,
        4.818163367910349715e-01, 2.078127356702541562e-03,
        7.308496727418317684e-01, 6.113458882036935105e-01,
        7.054926128857924583e-01, 6.069654187957521652e-01,
        3.426813203639234029e-02, 7.940586519295333989e-01,
        8.701121554312054585e-01, 3.633052266247521755e-01,
        6.339910166234810074e-01, 7.771720581876011558e-01,
        8.504081416756046341e-01, 3.970629444567075339e-02,
        3.056250679109674406e-01, 6.851739579754803078e-01,
        8.138603343107857491e-01, 2.489225776394842216e-01,
        5.757705969526882850e-01, 3.949567992589824161e-01,
        2.460547570068273293e-01, 1.072984660423375036e-01,
        5.396654661448940793e-02, 1.726292988498699943e-01,
        4.606692614389538143e-01, 8.077212438232332925e-01,
        2.901908344885238966e-01, 2.907479730855133671e-02,
        4.558424997924083177e-01, 1.528680003494213846e-01,
        4.240243758591606404e-01, 5.239624439137134937e-01,
        3.195718760233863254e-01, 7.872717947655142323e-01,
        9.985373837905713312e-01, 6.689263132396109368e-01,
        6.724606038203506664e-01, 1.861219660635715645e-02,
        9.700079771970812059e-01, 1.745529556650986525e-01,
        1.631721469222664478e-01, 4.908311781296891274e-01,
        2.063436082152860784e-01, 4.389492340639999934e-02,
        3.154508859437684665e-01, 8.021086379050585968e-01,
        3.864597103455974514e-01, 8.278880233694894120e-01,
        9.042596705053519424e-01, 1.655289109091289124e-01,
        4.794226889954540383e-01, 8.957172868506196872e-01,
        4.593218305235046151e-01, 4.413929083500328643e-01,
        1.637298478316178141e-01, 8.279025542029454510e-01,
        3.233074113779967895e-01, 5.534712352628948784e-01,
        3.687004327645670987e-02, 3.915491403829074457e-01,
        6.189967280995181120e-01, 4.357546006974363229e-01,
        1.031636724388182991e-01, 4.514245878539719925e-01,
        7.209871229749312826e-01, 3.324669328596879803e-01,
        1.234926732104708602e-01, 4.984786101143829917e-01,
        4.146811236046876736e-02, 3.826076967162970188e-01,
        2.903698072797483709e-01, 6.765410949945138697e-02,
        2.401410850991153589e-01, 4.850757546024752065e-01,
        1.402212803737700186e-01, 1.935828056590738200e-01,
        5.252282264268798295e-01, 9.017649130564721061e-01,
        6.893979120268841632e-01, 8.464280288385889195e-01,
        7.917629973078735839e-01, 3.868081040992861208e-01,
        7.413490610156794336e-01, 5.747861581522771823e-01,
        9.556066635146971411e-01, 9.281756829931175901e-01,
        1.969389456391348325e-01, 7.353408096079890877e-01,
        2.590590627152844494e-02, 7.743953514831383167e-01,
        4.918649776877301871e-01, 2.190264688830918516e-01,
        5.780011658115485895e-01, 3.908226757505547377e-01,
        8.123144813916431950e-01, 9.871104265347950824e-01,
        7.316098882532551251e-02, 3.392183802180862573e-01,
        6.601397448915372612e-01, 4.779814236994289756e-01,
        5.021384577181728925e-01, 7.671425453538004424e-01,
        9.313542441945829031e-01, 8.510295611305795926e-01,
        3.642387990713278345e-01, 5.242118734132216185e-01,
        8.336597448689591072e-01, 7.296440323778392578e-01,
        8.156597737446010798e-01, 1.442550639534185830e-01,
        1.572875662778911998e-01, 7.667068151365650230e-01,
        2.444672832272988261e-01, 1.472744981044137313e-01,
        3.602425024554937183e-01, 4.841556482138527073e-01,
        8.818309793961117693e-01, 3.171101471007539141e-01,
        3.601302078274588592e-01, 1.844534090625248313e-01,
        7.594893201143781969e-02, 7.092030457197306959e-02,
        4.072513801057348060e-01, 3.814305264739596968e-01,
        5.860849866352153548e-01, 8.661795257936568682e-01,
        8.943341888284841446e-01, 4.918293573415183362e-01,
        4.012211482028591458e-01, 5.078702737768907571e-01,
        2.995706478320416810e-01, 7.263925324831468355e-01,
        1.437117873013066260e-01, 2.593448086480925063e-01,
        2.381632204824396526e-01, 1.307189975584230890e-01,
        4.061157489147141364e-01, 8.817871487320734225e-01,
        7.733361963342810785e-02, 5.986910914169174536e-01,
        4.860182757063007397e-01, 6.969693681386508466e-01,
        7.737541365627520484e-02, 4.239621846416948836e-01,
        7.883301917954955718e-01, 4.383872002128134104e-01,
        6.373587778247402635e-01, 1.113468362903646813e-01,
        6.386722168937593036e-01, 6.223263729588612847e-01,
        7.009527933729710059e-01, 2.101808570387698749e-01,
        7.037797010655392205e-01, 6.089981609486208036e-01,
        7.901310317132613781e-01, 4.110693903003932448e-01,
        7.454451439143292557e-01, 4.332843903935252872e-01,
        6.018891865220450388e-01, 4.094279290751693390e-01,
        5.656686081520621023e-01, 5.473862504747538660e-01,
        3.520456708911973154e-01, 4.744210787586234934e-01,
        1.301597640036529224e-01, 1.025430317529401059e-01,
        2.534159150881702960e-01, 9.185211823528762753e-01,
        8.976557988799334087e-01, 5.371731306932402417e-01,
        6.798079213532323140e-01, 8.509744155048820646e-01,
        2.986719910430057912e-01, 2.593765888484138582e-01,
        2.177383086845008364e-02, 3.466487769894218696e-01,
        7.735646882957843973e-01, 9.953418172657695351e-01,
        2.443220270414525608e-01, 6.587543939971035600e-01,
        2.412708098211637786e-01, 3.512231360728199636e-01,
        1.026163484940922910e-02, 9.271678983510062144e-01,
        9.507945508946830104e-01, 8.165600463748164950e-01,
        7.695112783929555222e-01, 3.031926952525773045e-01,
        8.994180221528337293e-01, 1.792490767587486822e-01,
        9.622184404624143372e-01, 8.949633196850158567e-01,
        9.675397813761100752e-01, 8.808617574444804754e-01,
        4.613556134463737690e-01, 1.780703839282747891e-01,
        8.427674481277545038e-01, 2.043387384900552384e-01,
        8.775380360240871980e-01, 7.987093848882005354e-01,
        5.770211521310210090e-01, 4.743209705311834945e-01,
        4.682482078012840665e-01, 7.333920637264021991e-01,
        9.845153329973657108e-01, 3.084709484362871956e-01,
        4.940025046094914662e-01, 3.197354815398938399e-01,
        5.951210948944297696e-01, 4.414514770604700544e-01,
        4.064536760264118032e-01, 1.543497472825356986e-01,
        1.621405511120542764e-01, 7.252840417361523517e-01,
        9.514755026301079388e-01, 2.218859428355519636e-01,
        9.644127431820480600e-01, 3.732640594131162448e-01,
        8.464997697565304069e-01, 5.238361750913436143e-01,
        2.102962389662943465e-02, 1.728144880256132776e-02,
        1.166919497519370852e-01, 9.973269732205296556e-01,
        1.319648668867504648e-01, 6.567444656989929186e-01,
        1.865328884498063111e-02, 2.915307015813956015e-01,
        4.460693306560866711e-01, 9.511992403974040000e-01,
        8.440408717476705069e-01, 6.101212039004081378e-01,
        4.611734115885357532e-01, 7.554072319321447626e-01,
        8.711179137502881309e-01, 7.853681639748105736e-01,
        4.281132205447054639e-01, 7.502455553821514300e-01,
        4.662663684688361787e-01, 7.496095479337531176e-01,
        9.549198409880332861e-01, 1.718171172552246384e-01,
        5.451628096346741170e-01, 8.410744837182311251e-01,
        9.056804518364826029e-01, 3.224360127470745629e-01,
        4.141662547046002230e-01, 1.872579756722295707e-01,
        4.802901817510321081e-01, 5.459933398313681074e-01,
        1.998665262155472355e-01, 5.870378169841321547e-01,
        1.386196975219282645e-01, 5.371300725502099471e-01,
        8.208522211042965644e-01, 4.043359812383297003e-01,
        8.317564590028257987e-01, 2.662278845491207191e-01,
        8.494466946262393403e-01, 2.964340671083413037e-01,
        2.755543076566806526e-01, 8.650043600369519137e-01,
        7.708056690187173876e-01, 6.774951974096554697e-02,
        2.642084608194897877e-01, 6.904177171449267236e-01,
        6.514347954175924160e-01, 6.127840721328589035e-01,
        5.936826928802515502e-01, 6.544375571275354853e-01,
        2.631458920929147238e-01, 1.800748763922044304e-01,
        2.530361558870519723e-02, 4.856005913160299503e-02,
        9.362888186168334403e-01, 9.369177348698680685e-01,
        1.883206446360924380e-01, 3.796076000841469567e-01,
        2.193083700987668028e-01, 9.170883309875881295e-01,
        7.261711542537963027e-03, 3.192252537600598350e-01,
        5.520133395725946857e-01, 6.550288923940162933e-01,
        1.737425380938660835e-01, 3.798311300060632778e-01,
        7.465530834271024707e-01, 3.942887617201005224e-01,
        9.694285619293949718e-01, 9.470814438432360038e-01,
        6.762226444252341651e-01, 8.191003401729197719e-01,
        2.378898448831505696e-01, 8.092215815436671900e-01,
        2.393223263054596872e-01, 9.307537839505038990e-01,
        3.814314589677403333e-04, 4.633984121446299564e-01,
        5.167551921391372316e-01, 6.521550088581565818e-01,
        2.381309455246360951e-01, 6.251503906857073245e-01,
        3.116848600186888918e-01, 5.236412346036590781e-01,
        8.225131159629007760e-01, 9.054628748045412401e-02,
        1.828655671742456246e-01, 1.802101607216104462e-01,
        1.668149709514082923e-01, 4.357638702419105448e-01,
        7.498905146704359925e-02, 7.918719451433102741e-01,
        3.283907164498736098e-01, 7.561453274568109562e-01,
        6.711624798972577466e-01, 7.319520225049199746e-01,
        4.551239847893628898e-01, 1.374186144892394212e-01,
        7.862534690432193552e-01, 7.346836391037917524e-01,
        9.068954650850353794e-01, 8.364027436634359214e-01,
        5.510442845062080153e-03, 8.328251369490686784e-01,
        6.586751423740391242e-01, 4.523692552186833193e-01,
        3.928872261035555313e-01, 8.457640942083961555e-01,
        6.103117299081570746e-01, 7.976889907126293311e-01,
        2.829626532853803944e-01, 7.766461501690266056e-01,
        6.734839335949481809e-01, 8.344297159318466717e-01,
        7.886233443905559248e-01, 6.094438455550524880e-01,
        4.592865175824740742e-01, 9.033913962522632790e-02,
        7.985649621025151523e-01, 9.481680217974024494e-01,
        8.529322993359613747e-01, 9.817514634978112831e-01,
        1.280827189524450516e-01, 4.641543774120614474e-01,
        2.008161092591880248e-01, 1.871250260707576496e-01,
        7.815658390521111887e-01, 8.949314943372191911e-01,
        4.155846347468157287e-01, 6.888714619831732833e-01,
        9.313329988034931839e-01, 8.698233497597384067e-01,
        8.299064710618812013e-01, 6.012962473538290276e-01,
        2.919116739656539838e-01, 5.463923837677551187e-01,
        7.349221865052811831e-01, 9.076781175036554572e-01,
        5.783204835834019342e-01, 8.772901985511041278e-01,
        2.932460508800701637e-01, 1.697001825897362925e-01,
        9.852598703616468612e-01, 8.023068071721969341e-01,
        8.402314898038928392e-01, 9.035340996136760339e-01,
        5.404553878952820245e-01, 7.299856050355402193e-01,
        8.631599199457934413e-01, 1.024287364412875823e-01,
        8.450065105831173762e-01, 7.404334359738617977e-01,
        5.268470841439231167e-01, 4.568850048289572197e-01,
        3.736101948850315546e-01, 3.954483269505036924e-01,
        3.211111859859805406e-02, 3.308475421947908446e-01,
        2.239289653011784509e-01, 7.713069277312080141e-01,
        3.416627082377364788e-01, 5.840862441095125979e-01,
        3.584762284498662632e-01, 2.404652899339356775e-01,
        7.959157301628351222e-01, 8.493477874137264072e-01,
        2.353653964886678329e-01, 3.339660837656592829e-01,
        6.402944875868987751e-01, 7.389779100770198506e-01,
        5.587447138733079299e-01, 9.231761360523353943e-01,
        8.915814063532179201e-01, 4.060771463528662917e-01,
        7.863431550281871907e-01, 9.537876266316432927e-01,
        8.728063660371773169e-01, 3.934352205259872282e-01,
        7.477778790973310663e-02, 4.632632042039820375e-01,
        2.103444921297035197e-01, 9.273269749851842381e-01,
        3.647301227305030924e-01, 6.480230182977531062e-01,
        5.370610381024382152e-01, 7.521802549517438985e-01,
        7.254346427966951172e-01, 3.896638761850665933e-01,
        9.535839789116137277e-01, 2.752078042120708057e-01,
        4.935470733955227285e-01, 8.568330580836299726e-01,
        1.363893684187235111e-01, 1.675276199158272084e-01,
        9.359035416669629903e-01, 5.551842211027884222e-01,
        6.346656006696528296e-01, 6.914904772545009681e-01,
        4.274200213681811356e-01, 8.162929442895476839e-01,
        6.731527327180006903e-01, 9.436224673406966579e-01,
        8.466889946034285019e-01, 5.045002227418208252e-01,
        3.068760121997924362e-01, 1.529883462618002454e-01,
        7.936541453123975298e-01, 1.558842829767508320e-01,
        1.059813814412403632e-01, 7.038994555138020637e-01,
        3.317497183508556491e-01, 9.004822083008534594e-02,
        7.077107420870329957e-01, 1.569875892710794751e-01,
        2.696390456163111349e-02, 7.928853869738751170e-01,
        8.671835260456304262e-01, 1.217729478315335845e-01,
        8.504865251411655169e-01, 9.322863184010395932e-01,
        5.991738625969668108e-01, 6.984792648394289039e-01,
        7.350910502757341813e-01, 6.524708834177815886e-01,
        2.696797754167399308e-01, 3.996893732665631749e-01,
        2.592408291424527222e-01, 2.154334722108054434e-01,
        7.420947501285077852e-01, 3.616507586086641357e-01,
        1.177806377093296719e-01, 2.338921221549055129e-01,
        1.295192098667776737e-01, 9.993417653522852495e-01,
        7.988657940123223833e-01, 2.790258762350356081e-01,
        5.763221693339348750e-01, 1.226583763084390100e-01,
        4.799194350153762612e-01, 4.146533923212601946e-01,
        1.319375923730378153e-01, 6.522313433336981436e-01,
        4.584614051490132347e-03, 9.382785056522914280e-01,
        1.973417713816610908e-01, 5.901165057379083034e-01,
    };

    const auto sparse = fromDense<double, CPUMem>(dense, num_rows);
    const auto m = sparse.getView();

    static constexpr size_t len_scratch = 1;
    using T = double;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(num_rows, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, num_rows, len_scratch);

    s->candidate.data()[0] = 2195319283;

    mx(m, s);

    // m @ x computed with numpy
    std::array yres{
        11.69594869, 8.96109356, 7.57017507,  8.23711123,  7.15480026,
        9.29106933,  8.39616403, 9.07276192,  9.13776811,  9.56161941,
        7.56907431,  8.99047199, 10.44315842, 8.30023957,  7.04971485,
        8.64338538,  7.15102059, 9.83743893,  8.95821975,  6.48078777,
        9.03128809,  8.86861241, 9.72985171,  10.6554014,  9.84920346,
        8.90542876,  9.60524293, 9.47918066,  11.71554695, 9.98275545,
        10.00427651, 6.90319684,
    };

    for (auto i = 0; i < yres.size(); i++) {
        const auto diff = abs(s->rows[i] - yres[i]);
        assert(diff < 1e-5);
    }
}

void testBlockDotProduct1() {
    std::printf("Testing block dot product 1\n");

    static constexpr size_t len_data = 4;
    static constexpr size_t len_scratch = 1;
    using T = float;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(len_data, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, len_data, len_scratch);

    s->candidate.flip(0);
    s->candidate.flip(3);
    s->rows[0] = 0.0f;
    s->rows[1] = -1.0f;
    s->rows[2] = 2.0f;
    s->rows[3] = 3.5f;

    assert(blockDotProd(s) == 3.5f);
}

void testBlockDotProduct2() {
    std::printf("Testing block dot product 2\n");

    static constexpr size_t len_data = 4;
    static constexpr size_t len_scratch = 1;
    using T = float;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(len_data, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, len_data, len_scratch);

    s->candidate.flip(1);
    s->candidate.flip(2);
    s->rows[0] = 0.0f;
    s->rows[1] = -1.0f;
    s->rows[2] = 2.0f;
    s->rows[3] = 3.5f;

    assert(blockDotProd(s) == -1.0f + 2.0f);
}

void testMinimumRow() {
    std::printf("Testing minimumRow search\n");

    static constexpr uint32_t num_rows = 32;
    std::vector<double> dense{
        5.942730528399744472e-01, 4.943969860436798758e-01,
        4.450847693527698601e-01, 8.767649740877209164e-01,
        4.054333830561835383e-01, 4.999222828511122874e-01,
        3.826815354975575123e-01, 3.340722083247833485e-01,
        6.279596773249214170e-01, 2.251549829171287098e-01,
        1.986545444226572865e-01, 9.357747070377553378e-01,
        6.326340120830891145e-01, 3.311346730519129644e-01,
        6.264076347834319769e-01, 9.724832044302037515e-01,
        6.297193178362305854e-01, 6.212828603028799357e-01,
        7.625446368329245050e-01, 4.541757768365274894e-01,
        6.171061403261197675e-01, 5.744577419942482610e-01,
        3.305157842807399105e-01, 5.865066865935431029e-01,
        5.407337641947700391e-01, 3.286277894440371439e-01,
        6.293241535086291361e-01, 5.150808254926644292e-01,
        6.416008274184521465e-01, 7.604218143133705254e-01,
        5.636522280341318414e-01, 3.952210451791832724e-01,
        4.943969860436798758e-01, 8.839765516369791909e-01,
        4.963480764744764850e-01, 4.322560509677699780e-01,
        5.891456477769203559e-01, 3.542100204745523007e-01,
        2.513125533926385824e-01, 5.786661318221772987e-01,
        5.140307620576374248e-01, 2.552217915853447483e-01,
        4.718757721947782757e-01, 6.524329920689263540e-01,
        6.110142977860718583e-01, 8.302779656400374186e-01,
        4.976242904890635366e-01, 6.535386503902147481e-01,
        6.395210782684976891e-01, 6.261694891809495012e-01,
        1.997296043516126329e-01, 5.045586184862647094e-01,
        7.517533510680312059e-01, 2.837580557029898420e-01,
        2.022808704433795568e-01, 4.572869495750678803e-01,
        4.815566695927993579e-01, 5.560696585985764884e-01,
        8.786866809353743868e-01, 5.038295870697994117e-01,
        5.649640967350475496e-01, 4.742825862332017417e-01,
        7.164651084728732577e-01, 5.521779457399671465e-01,
        4.450847693527698601e-01, 4.963480764744764850e-01,
        8.568883185702296235e-01, 3.854359749981637329e-01,
        5.159381151909574470e-01, 8.773024095511317011e-01,
        1.267431281835304513e-01, 4.372885495191148886e-01,
        5.494978154982063101e-01, 7.114324700224785580e-01,
        5.990087412207660833e-01, 2.415530795431968247e-01,
        6.539151775414659973e-01, 5.210208082920830819e-02,
        2.500551692287381056e-01, 2.875962386398734361e-01,
        8.259139526806078546e-01, 5.173153024400112265e-01,
        1.758897943482978232e-01, 6.906483807494311344e-01,
        7.039503758408230949e-01, 6.438700025701311613e-01,
        6.911646804017608225e-01, 2.675741824812734038e-01,
        1.405614196540564964e-01, 8.094632716078467016e-01,
        4.044937875030812924e-01, 2.386852606608171889e-01,
        4.840104121101163059e-01, 4.546524631426674956e-01,
        3.672693654801370555e-01, 7.159762318066181797e-01,
        8.767649740877209164e-01, 4.322560509677699780e-01,
        3.854359749981637329e-01, 8.749737745763492835e-01,
        3.232139243393603589e-01, 4.312221866275817717e-01,
        6.207102928662378005e-01, 6.429245223938384601e-01,
        7.521796692743685231e-01, 6.014243396119718366e-01,
        1.464660076653684362e-01, 4.623653055472529694e-01,
        3.557671714096016791e-01, 6.106399047378208156e-01,
        6.906907064985643441e-01, 3.715065754206375304e-01,
        3.895206417387635511e-01, 1.014166571950221307e-01,
        5.073716511620915970e-01, 3.477304064969257702e-01,
        6.721696383401307706e-01, 1.968416453722319215e-01,
        6.840239321733381228e-01, 2.807061649652577984e-01,
        5.095390951204166186e-01, 2.040689674309519863e-01,
        2.953783946869132371e-01, 3.077466322938677279e-01,
        8.370281991472735550e-01, 4.808383964023238422e-01,
        5.897862311488909492e-01, 1.978044434381087679e-01,
        4.054333830561835383e-01, 5.891456477769203559e-01,
        5.159381151909574470e-01, 3.232139243393603589e-01,
        9.322317712421887004e-01, 6.287798486667510733e-01,
        5.591694416768362430e-01, 1.240280945925237299e-01,
        7.758917051092750761e-02, 7.336513928037191601e-01,
        2.773359007671116760e-01, 3.160014722964881173e-01,
        5.472523989244697518e-01, 7.843915512385901678e-01,
        6.776877568282506648e-01, 8.520945865241384976e-01,
        6.550491333650247938e-01, 7.907737087843041968e-02,
        3.739456960245226003e-01, 4.873977674442017682e-01,
        1.802440269967759412e-01, 3.381149784223742571e-01,
        4.143977567866309331e-01, 3.073991206370622065e-01,
        7.232264249796414024e-01, 4.721967861061472371e-01,
        1.562623442464528556e-01, 1.678654085532153006e-01,
        5.485630962822327650e-01, 3.637327975760900611e-01,
        3.652923141057710654e-01, 4.674982805512734041e-01,
        4.999222828511122874e-01, 3.542100204745523007e-01,
        8.773024095511317011e-01, 4.312221866275817717e-01,
        6.287798486667510733e-01, 4.379990663199319068e-01,
        6.872385824702857970e-01, 8.293915027436737919e-01,
        6.922267961630750310e-01, 4.513748935909246973e-01,
        7.034662111535228135e-01, 1.621875183616731109e-01,
        1.299086186926137199e-01, 4.256152303502194201e-01,
        9.423096988927985862e-01, 4.633196477352037879e-01,
        3.328675000855761401e-01, 5.185660705661583325e-01,
        2.328163623263246329e-01, 8.949451519926900911e-01,
        7.626210555635004607e-01, 3.548731050072273518e-01,
        2.759056859499416925e-01, 8.783249949131965995e-01,
        5.859595395856556088e-01, 3.722490855194764414e-01,
        6.274689208451870170e-01, 5.758212405197693506e-01,
        2.607256432545650982e-01, 3.051412228590866249e-01,
        6.883649840175515289e-01, 4.766888141551791080e-01,
        3.826815354975575123e-01, 2.513125533926385824e-01,
        1.267431281835304513e-01, 6.207102928662378005e-01,
        5.591694416768362430e-01, 6.872385824702857970e-01,
        3.749244706947130190e-01, 4.922683725265061816e-01,
        5.248061961972558809e-01, 7.001585459888165497e-01,
        5.726013512862310195e-01, 4.925099738372403779e-01,
        7.005780483960145633e-01, 5.489360985116982228e-01,
        4.974452153961542167e-01, 3.686994686501169349e-01,
        6.764431806878508091e-01, 6.246198376494729310e-01,
        2.963762832691390625e-01, 5.745133013133683075e-01,
        2.912616738137164263e-01, 2.837741438308066799e-01,
        6.453681651420253296e-01, 7.310054142036179758e-01,
        5.243364905374918727e-01, 3.466227696825535110e-01,
        3.842638347839034685e-01, 5.434913761988746650e-01,
        1.877520541587662239e-01, 3.360834810514809479e-01,
        8.015964376939536118e-01, 3.189812312602344768e-01,
        3.340722083247833485e-01, 5.786661318221772987e-01,
        4.372885495191148886e-01, 6.429245223938384601e-01,
        1.240280945925237299e-01, 8.293915027436737919e-01,
        4.922683725265061816e-01, 5.736814547993476232e-01,
        1.562426236707604166e-01, 5.016960343918893672e-01,
        2.130939800106741444e-01, 5.965287922826330025e-01,
        4.766528974477544089e-01, 2.725487742442959105e-01,
        2.308677911562382334e-01, 3.509091331202338071e-01,
        5.542727479308034999e-01, 3.973596760397400951e-01,
        6.016640607626024817e-01, 2.792668271963044124e-01,
        5.551061207796383901e-01, 3.915284817552658336e-01,
        3.280811919069630544e-01, 5.977762206584760207e-01,
        3.859581433064402933e-01, 2.983365161059861603e-01,
        2.709214565458348267e-01, 8.410441295771762249e-01,
        5.630846030498675159e-01, 6.305074057690724931e-01,
        6.252837921649689878e-01, 8.065228448784499404e-01,
        6.279596773249214170e-01, 5.140307620576374248e-01,
        5.494978154982063101e-01, 7.521796692743685231e-01,
        7.758917051092750761e-02, 6.922267961630750310e-01,
        5.248061961972558809e-01, 1.562426236707604166e-01,
        8.982539211291831194e-01, 4.405370466481199898e-01,
        1.185747923505909851e-01, 4.386358193751147549e-01,
        5.897684559728335607e-01, 4.515716428284702877e-01,
        6.608118370995663682e-01, 8.754850973831298511e-01,
        3.117583130563129634e-01, 4.105587448256445282e-01,
        4.783448264312469833e-01, 2.367487470763807167e-01,
        5.438586206873496920e-01, 2.235948712831211105e-01,
        4.404531110157927087e-01, 7.926843623313194476e-01,
        7.952918023015468352e-01, 2.703205541134393042e-01,
        2.800016560127155385e-01, 7.773547473524289320e-01,
        4.422574570005935457e-01, 4.774009607729517990e-01,
        3.706074542128293126e-01, 4.635132091735049698e-01,
        2.251549829171287098e-01, 2.552217915853447483e-01,
        7.114324700224785580e-01, 6.014243396119718366e-01,
        7.336513928037191601e-01, 4.513748935909246973e-01,
        7.001585459888165497e-01, 5.016960343918893672e-01,
        4.405370466481199898e-01, 9.115625979886382568e-01,
        3.647057638793629875e-01, 8.916875674279483022e-01,
        2.094917241940290054e-01, 4.345103923311356420e-01,
        2.635580320270904942e-01, 6.733259532904054545e-01,
        6.071266535673753850e-01, 7.708564206076973235e-01,
        4.858129102161677371e-01, 5.873593877960807674e-01,
        3.340523599795570675e-01, 5.947531792726137301e-01,
        5.362673065846128573e-01, 1.957111016661866598e-01,
        5.149448584676685758e-01, 6.990699397656017222e-01,
        6.696457214591200469e-01, 4.084264814999930548e-01,
        8.987138894628926566e-01, 4.776590636345899310e-01,
        5.439251295300220335e-01, 3.264258382827074367e-01,
        1.986545444226572865e-01, 4.718757721947782757e-01,
        5.990087412207660833e-01, 1.464660076653684362e-01,
        2.773359007671116760e-01, 7.034662111535228135e-01,
        5.726013512862310195e-01, 2.130939800106741444e-01,
        1.185747923505909851e-01, 3.647057638793629875e-01,
        2.909342658715992069e-01, 5.318411879227129546e-01,
        1.175773406492504614e-01, 2.138300894127770357e-01,
        4.893537700964927795e-01, 7.858857237395189266e-01,
        4.275399249558593517e-01, 3.664229474907982342e-01,
        6.364172404685399798e-01, 5.530114105035470740e-01,
        6.102877295738395880e-01, 5.148786249816370564e-01,
        4.837587653144975741e-01, 4.935089085733792569e-01,
        4.832429769887987003e-01, 3.498528104258672999e-01,
        4.914548111651459994e-01, 4.104621296442947376e-01,
        3.615806610660072806e-01, 5.550907601722524509e-01,
        1.444992478935794300e-01, 1.381282800525798771e-01,
        9.357747070377553378e-01, 6.524329920689263540e-01,
        2.415530795431968247e-01, 4.623653055472529694e-01,
        3.160014722964881173e-01, 1.621875183616731109e-01,
        4.925099738372403779e-01, 5.965287922826330025e-01,
        4.386358193751147549e-01, 8.916875674279483022e-01,
        5.318411879227129546e-01, 8.452350856735054707e-01,
        3.962865822221317558e-02, 5.373477491083109570e-01,
        7.952866956627296924e-01, 9.607358599352761042e-02,
        4.777863913702102838e-01, 5.484713516926489341e-01,
        8.256261730230812779e-02, 2.567912243524657079e-01,
        4.827207359360733974e-01, 5.900235818695159784e-01,
        4.931761243694498531e-01, 2.419249442605224676e-01,
        8.580397672248246677e-02, 5.446046217641256071e-01,
        4.857335938497409633e-01, 1.463192617957400077e-01,
        6.917594056172897687e-01, 7.037594686541170930e-01,
        5.026419244326776337e-01, 6.145031483819434204e-01,
        6.326340120830891145e-01, 6.110142977860718583e-01,
        6.539151775414659973e-01, 3.557671714096016791e-01,
        5.472523989244697518e-01, 1.299086186926137199e-01,
        7.005780483960145633e-01, 4.766528974477544089e-01,
        5.897684559728335607e-01, 2.094917241940290054e-01,
        1.175773406492504614e-01, 3.962865822221317558e-02,
        5.101887555650711503e-01, 8.388645943456588538e-01,
        1.385701713461788831e-01, 7.933892009522214295e-01,
        3.677912693301362834e-01, 5.291534772698345268e-01,
        6.671412967868683985e-01, 2.616025228650604162e-01,
        4.293981405046170541e-01, 6.570621668321373621e-01,
        7.892323388258859485e-01, 9.191663814122796872e-01,
        3.625177758308810727e-01, 8.057967454654795247e-01,
        7.041136329168252717e-01, 7.273662913895683202e-01,
        8.480503831625103572e-01, 4.250273029196012242e-01,
        7.986383870153213049e-01, 5.826515763567299278e-01,
        3.311346730519129644e-01, 8.302779656400374186e-01,
        5.210208082920830819e-02, 6.106399047378208156e-01,
        7.843915512385901678e-01, 4.256152303502194201e-01,
        5.489360985116982228e-01, 2.725487742442959105e-01,
        4.515716428284702877e-01, 4.345103923311356420e-01,
        2.138300894127770357e-01, 5.373477491083109570e-01,
        8.388645943456588538e-01, 5.332373658681816009e-01,
        6.585321895225719757e-01, 5.748151499816529508e-01,
        7.471077453424004311e-01, 2.862236010435844080e-01,
        2.734035814932620490e-01, 6.475913206721896076e-01,
        5.478776123565896050e-01, 3.755720568794032599e-01,
        6.421451294572846358e-01, 4.532383579360005355e-01,
        8.171242771634733559e-01, 6.808532396001474307e-01,
        2.974641972958305125e-01, 5.023114034246628501e-01,
        8.882022539009262196e-01, 1.518244468239161593e-01,
        7.089351274870658859e-01, 3.398389494732371729e-01,
        6.264076347834319769e-01, 4.976242904890635366e-01,
        2.500551692287381056e-01, 6.906907064985643441e-01,
        6.776877568282506648e-01, 9.423096988927985862e-01,
        4.974452153961542167e-01, 2.308677911562382334e-01,
        6.608118370995663682e-01, 2.635580320270904942e-01,
        4.893537700964927795e-01, 7.952866956627296924e-01,
        1.385701713461788831e-01, 6.585321895225719757e-01,
        9.464544860108432545e-01, 5.076013333086091261e-01,
        3.488269611862402919e-01, 4.554763148296480657e-01,
        1.631210159489470679e-01, 6.443048372958810610e-01,
        1.405657260863322766e-01, 4.403971185979216330e-01,
        6.768660408616997692e-01, 5.139971756749115439e-01,
        4.858115601086532287e-01, 5.576752264905897594e-01,
        5.338113645373008254e-01, 4.561675319362792913e-01,
        6.977786457539357778e-01, 5.115508308831979711e-01,
        7.444203236230797494e-01, 5.271373108388693884e-01,
        9.724832044302037515e-01, 6.535386503902147481e-01,
        2.875962386398734361e-01, 3.715065754206375304e-01,
        8.520945865241384976e-01, 4.633196477352037879e-01,
        3.686994686501169349e-01, 3.509091331202338071e-01,
        8.754850973831298511e-01, 6.733259532904054545e-01,
        7.858857237395189266e-01, 9.607358599352761042e-02,
        7.933892009522214295e-01, 5.748151499816529508e-01,
        5.076013333086091261e-01, 1.808347239226427705e-01,
        2.867348749238212147e-01, 3.873353821038852951e-01,
        4.702185341978043498e-01, 2.720961749868592294e-01,
        3.788858596174674020e-01, 6.326130115836006151e-01,
        4.679461260184809568e-01, 5.773275550634641151e-01,
        4.873824984100982305e-01, 1.690649920310376420e-01,
        8.324909911429634324e-01, 7.042945034842507113e-01,
        4.337093419822924401e-01, 7.129318851352177688e-01,
        5.361882841921545850e-01, 2.285481325383386109e-01,
        6.297193178362305854e-01, 6.395210782684976891e-01,
        8.259139526806078546e-01, 3.895206417387635511e-01,
        6.550491333650247938e-01, 3.328675000855761401e-01,
        6.764431806878508091e-01, 5.542727479308034999e-01,
        3.117583130563129634e-01, 6.071266535673753850e-01,
        4.275399249558593517e-01, 4.777863913702102838e-01,
        3.677912693301362834e-01, 7.471077453424004311e-01,
        3.488269611862402919e-01, 2.867348749238212147e-01,
        1.917099615992804429e-01, 8.445563662332199462e-01,
        6.066582128567695742e-01, 5.274337257639498677e-01,
        8.120352579317666741e-01, 6.290877286628624443e-01,
        5.282860359030407960e-01, 5.099931002577233752e-01,
        2.921759482900123661e-01, 5.897259619345247561e-01,
        5.753106334056373727e-01, 1.223589545676667667e-02,
        4.996207960252895819e-01, 1.540554721363839308e-01,
        2.543974685949278447e-01, 3.880773203008054395e-01,
        6.212828603028799357e-01, 6.261694891809495012e-01,
        5.173153024400112265e-01, 1.014166571950221307e-01,
        7.907737087843041968e-02, 5.185660705661583325e-01,
        6.246198376494729310e-01, 3.973596760397400951e-01,
        4.105587448256445282e-01, 7.708564206076973235e-01,
        3.664229474907982342e-01, 5.484713516926489341e-01,
        5.291534772698345268e-01, 2.862236010435844080e-01,
        4.554763148296480657e-01, 3.873353821038852951e-01,
        8.445563662332199462e-01, 6.113458882036935105e-01,
        6.872094630627016976e-01, 5.527220144550675229e-01,
        2.561247778679106579e-01, 7.602255922063401172e-01,
        6.722666170949145314e-01, 2.706878052765134823e-01,
        4.627608591024383045e-01, 5.368030626479711742e-01,
        8.347542409242622030e-01, 4.362657156973697159e-01,
        4.260087258393612797e-01, 5.095700208705697953e-01,
        8.150766393001667165e-01, 2.414073498971948672e-01,
        7.625446368329245050e-01, 1.997296043516126329e-01,
        1.758897943482978232e-01, 5.073716511620915970e-01,
        3.739456960245226003e-01, 2.328163623263246329e-01,
        2.963762832691390625e-01, 6.016640607626024817e-01,
        4.783448264312469833e-01, 4.858129102161677371e-01,
        6.364172404685399798e-01, 8.256261730230812779e-02,
        6.671412967868683985e-01, 2.734035814932620490e-01,
        1.631210159489470679e-01, 4.702185341978043498e-01,
        6.066582128567695742e-01, 6.872094630627016976e-01,
        6.724606038203506664e-01, 3.004015448341296191e-02,
        7.360732174576269937e-01, 1.591323714832026393e-01,
        1.466659554629596851e-01, 6.667993131287217601e-01,
        3.262064694356863748e-01, 1.597246155315403260e-01,
        2.766703654134595181e-01, 7.303918901395488605e-01,
        5.606909484254393172e-01, 7.340912554781940935e-01,
        7.887062016116763719e-01, 1.475240603879532930e-01,
        4.541757768365274894e-01, 5.045586184862647094e-01,
        6.906483807494311344e-01, 3.477304064969257702e-01,
        4.873977674442017682e-01, 8.949451519926900911e-01,
        5.745133013133683075e-01, 2.792668271963044124e-01,
        2.367487470763807167e-01, 5.873593877960807674e-01,
        5.530114105035470740e-01, 2.567912243524657079e-01,
        2.616025228650604162e-01, 6.475913206721896076e-01,
        6.443048372958810610e-01, 2.720961749868592294e-01,
        5.274337257639498677e-01, 5.527220144550675229e-01,
        3.004015448341296191e-02, 3.826076967162970188e-01,
        5.287561763167744067e-01, 1.634994590737719466e-01,
        1.713420584260277324e-01, 3.447072465462652224e-01,
        5.457102603855870093e-01, 5.292935828480128668e-01,
        6.672249039852735653e-01, 6.770670841375776572e-01,
        7.985380147652698657e-01, 7.927029694578043850e-01,
        8.676927323242851209e-01, 6.930749347257856297e-01,
        6.171061403261197675e-01, 7.517533510680312059e-01,
        7.039503758408230949e-01, 6.721696383401307706e-01,
        1.802440269967759412e-01, 7.626210555635004607e-01,
        2.912616738137164263e-01, 5.551061207796383901e-01,
        5.438586206873496920e-01, 3.340523599795570675e-01,
        6.102877295738395880e-01, 4.827207359360733974e-01,
        4.293981405046170541e-01, 5.478776123565896050e-01,
        1.405657260863322766e-01, 3.788858596174674020e-01,
        8.120352579317666741e-01, 2.561247778679106579e-01,
        7.360732174576269937e-01, 5.287561763167744067e-01,
        9.313542441945829031e-01, 5.445963908065096781e-01,
        3.088273570797490652e-01, 7.008749547186543527e-01,
        8.388503083083147516e-01, 7.502248506982782672e-01,
        5.274910500250303835e-01, 2.685711450284870572e-01,
        3.678040249306465670e-01, 6.627257645049364765e-01,
        5.455781389153636640e-01, 4.730701460583680573e-01,
        5.744577419942482610e-01, 2.837580557029898420e-01,
        6.438700025701311613e-01, 1.968416453722319215e-01,
        3.381149784223742571e-01, 3.548731050072273518e-01,
        2.837741438308066799e-01, 3.915284817552658336e-01,
        2.235948712831211105e-01, 5.947531792726137301e-01,
        5.148786249816370564e-01, 5.900235818695159784e-01,
        6.570621668321373621e-01, 3.755720568794032599e-01,
        4.403971185979216330e-01, 6.326130115836006151e-01,
        6.290877286628624443e-01, 7.602255922063401172e-01,
        1.591323714832026393e-01, 1.634994590737719466e-01,
        5.445963908065096781e-01, 1.307189975584230890e-01,
        6.623184656337952614e-01, 8.402482668101369789e-01,
        3.437274117669181228e-01, 3.332203055789415003e-01,
        7.083860298284023749e-01, 7.713667311735235010e-01,
        4.773328061036896663e-01, 6.735691603470150834e-01,
        6.464152072686581985e-01, 3.587065382239245093e-01,
        3.305157842807399105e-01, 2.022808704433795568e-01,
        6.911646804017608225e-01, 6.840239321733381228e-01,
        4.143977567866309331e-01, 2.759056859499416925e-01,
        6.453681651420253296e-01, 3.280811919069630544e-01,
        4.404531110157927087e-01, 5.362673065846128573e-01,
        4.837587653144975741e-01, 4.931761243694498531e-01,
        7.892323388258859485e-01, 6.421451294572846358e-01,
        6.768660408616997692e-01, 4.679461260184809568e-01,
        5.282860359030407960e-01, 6.722666170949145314e-01,
        1.466659554629596851e-01, 1.713420584260277324e-01,
        3.088273570797490652e-01, 6.623184656337952614e-01,
        8.976557988799334087e-01, 5.570971414121306253e-01,
        5.704906664708839781e-01, 5.575914381621859262e-01,
        1.495267112509867657e-01, 4.348441593782854664e-01,
        1.575099408742601237e-01, 6.191150916713199504e-01,
        5.402203502477884722e-01, 7.858319932998522050e-01,
        5.865066865935431029e-01, 4.572869495750678803e-01,
        2.675741824812734038e-01, 2.807061649652577984e-01,
        3.073991206370622065e-01, 8.783249949131965995e-01,
        7.310054142036179758e-01, 5.977762206584760207e-01,
        7.926843623313194476e-01, 1.957111016661866598e-01,
        4.935089085733792569e-01, 2.419249442605224676e-01,
        9.191663814122796872e-01, 4.532383579360005355e-01,
        5.139971756749115439e-01, 5.773275550634641151e-01,
        5.099931002577233752e-01, 2.706878052765134823e-01,
        6.667993131287217601e-01, 3.447072465462652224e-01,
        7.008749547186543527e-01, 8.402482668101369789e-01,
        5.570971414121306253e-01, 4.743209705311834945e-01,
        6.118277198667143590e-01, 7.119048904356644059e-01,
        7.239568725709978336e-01, 5.530799695744582634e-01,
        3.318513435996138794e-01, 3.629063139463800658e-01,
        3.740547205781150075e-01, 2.820549266844545322e-01,
        5.407337641947700391e-01, 4.815566695927993579e-01,
        1.405614196540564964e-01, 5.095390951204166186e-01,
        7.232264249796414024e-01, 5.859595395856556088e-01,
        5.243364905374918727e-01, 3.859581433064402933e-01,
        7.952918023015468352e-01, 5.149448584676685758e-01,
        4.832429769887987003e-01, 8.580397672248246677e-02,
        3.625177758308810727e-01, 8.171242771634733559e-01,
        4.858115601086532287e-01, 4.873824984100982305e-01,
        2.921759482900123661e-01, 4.627608591024383045e-01,
        3.262064694356863748e-01, 5.457102603855870093e-01,
        8.388503083083147516e-01, 3.437274117669181228e-01,
        5.704906664708839781e-01, 6.118277198667143590e-01,
        8.711179137502881309e-01, 7.184014796962014948e-01,
        4.724342063419213478e-01, 5.166041043337659122e-01,
        7.257631194152415199e-01, 7.679763514809700986e-01,
        8.742869931502154079e-01, 3.258682761353004498e-01,
        3.286277894440371439e-01, 5.560696585985764884e-01,
        8.094632716078467016e-01, 2.040689674309519863e-01,
        4.721967861061472371e-01, 3.722490855194764414e-01,
        3.466227696825535110e-01, 2.983365161059861603e-01,
        2.703205541134393042e-01, 6.990699397656017222e-01,
        3.498528104258672999e-01, 5.446046217641256071e-01,
        8.057967454654795247e-01, 6.808532396001474307e-01,
        5.576752264905897594e-01, 1.690649920310376420e-01,
        5.897259619345247561e-01, 5.368030626479711742e-01,
        1.597246155315403260e-01, 5.292935828480128668e-01,
        7.502248506982782672e-01, 3.332203055789415003e-01,
        5.575914381621859262e-01, 7.119048904356644059e-01,
        7.184014796962014948e-01, 6.127840721328589035e-01,
        6.229188508692040660e-01, 7.155418536482810454e-01,
        5.327263496325558290e-01, 5.669312515119238061e-01,
        9.059394928272801462e-02, 2.316067257264315948e-01,
        6.293241535086291361e-01, 8.786866809353743868e-01,
        4.044937875030812924e-01, 2.953783946869132371e-01,
        1.562623442464528556e-01, 6.274689208451870170e-01,
        3.842638347839034685e-01, 2.709214565458348267e-01,
        2.800016560127155385e-01, 6.696457214591200469e-01,
        4.914548111651459994e-01, 4.857335938497409633e-01,
        7.041136329168252717e-01, 2.974641972958305125e-01,
        5.338113645373008254e-01, 8.324909911429634324e-01,
        5.753106334056373727e-01, 8.347542409242622030e-01,
        2.766703654134595181e-01, 6.672249039852735653e-01,
        5.274910500250303835e-01, 7.083860298284023749e-01,
        1.495267112509867657e-01, 7.239568725709978336e-01,
        4.724342063419213478e-01, 6.229188508692040660e-01,
        2.381309455246360951e-01, 6.493171621403277527e-01,
        5.759581749112908655e-01, 6.982238003204181975e-01,
        4.642472487020705696e-01, 1.112419399267459696e-01,
        5.150808254926644292e-01, 5.038295870697994117e-01,
        2.386852606608171889e-01, 3.077466322938677279e-01,
        1.678654085532153006e-01, 5.758212405197693506e-01,
        5.434913761988746650e-01, 8.410441295771762249e-01,
        7.773547473524289320e-01, 4.084264814999930548e-01,
        4.104621296442947376e-01, 1.463192617957400077e-01,
        7.273662913895683202e-01, 5.023114034246628501e-01,
        4.561675319362792913e-01, 7.042945034842507113e-01,
        1.223589545676667667e-02, 4.362657156973697159e-01,
        7.303918901395488605e-01, 6.770670841375776572e-01,
        2.685711450284870572e-01, 7.713667311735235010e-01,
        4.348441593782854664e-01, 5.530799695744582634e-01,
        5.166041043337659122e-01, 7.155418536482810454e-01,
        6.493171621403277527e-01, 8.344297159318466717e-01,
        8.460787220021159794e-01, 5.014395330405199136e-01,
        5.815929865481380689e-01, 3.712852414794622358e-01,
        6.416008274184521465e-01, 5.649640967350475496e-01,
        4.840104121101163059e-01, 8.370281991472735550e-01,
        5.485630962822327650e-01, 2.607256432545650982e-01,
        1.877520541587662239e-01, 5.630846030498675159e-01,
        4.422574570005935457e-01, 8.987138894628926566e-01,
        3.615806610660072806e-01, 6.917594056172897687e-01,
        8.480503831625103572e-01, 8.882022539009262196e-01,
        6.977786457539357778e-01, 4.337093419822924401e-01,
        4.996207960252895819e-01, 4.260087258393612797e-01,
        5.606909484254393172e-01, 7.985380147652698657e-01,
        3.678040249306465670e-01, 4.773328061036896663e-01,
        1.575099408742601237e-01, 3.318513435996138794e-01,
        7.257631194152415199e-01, 5.327263496325558290e-01,
        5.759581749112908655e-01, 8.460787220021159794e-01,
        5.404553878952820245e-01, 4.023816964726366630e-01,
        5.974548191483245452e-01, 5.350667524638885730e-02,
        7.604218143133705254e-01, 4.742825862332017417e-01,
        4.546524631426674956e-01, 4.808383964023238422e-01,
        3.637327975760900611e-01, 3.051412228590866249e-01,
        3.360834810514809479e-01, 6.305074057690724931e-01,
        4.774009607729517990e-01, 4.776590636345899310e-01,
        5.550907601722524509e-01, 7.037594686541170930e-01,
        4.250273029196012242e-01, 1.518244468239161593e-01,
        5.115508308831979711e-01, 7.129318851352177688e-01,
        1.540554721363839308e-01, 5.095700208705697953e-01,
        7.340912554781940935e-01, 7.927029694578043850e-01,
        6.627257645049364765e-01, 6.735691603470150834e-01,
        6.191150916713199504e-01, 3.629063139463800658e-01,
        7.679763514809700986e-01, 5.669312515119238061e-01,
        6.982238003204181975e-01, 5.014395330405199136e-01,
        4.023816964726366630e-01, 4.632632042039820375e-01,
        1.501963564798944328e-01, 9.328027403187377775e-01,
        5.636522280341318414e-01, 7.164651084728732577e-01,
        3.672693654801370555e-01, 5.897862311488909492e-01,
        3.652923141057710654e-01, 6.883649840175515289e-01,
        8.015964376939536118e-01, 6.252837921649689878e-01,
        3.706074542128293126e-01, 5.439251295300220335e-01,
        1.444992478935794300e-01, 5.026419244326776337e-01,
        7.986383870153213049e-01, 7.089351274870658859e-01,
        7.444203236230797494e-01, 5.361882841921545850e-01,
        2.543974685949278447e-01, 8.150766393001667165e-01,
        7.887062016116763719e-01, 8.676927323242851209e-01,
        5.455781389153636640e-01, 6.464152072686581985e-01,
        5.402203502477884722e-01, 3.740547205781150075e-01,
        8.742869931502154079e-01, 9.059394928272801462e-02,
        4.642472487020705696e-01, 5.815929865481380689e-01,
        5.974548191483245452e-01, 1.501963564798944328e-01,
        7.077107420870329957e-01, 1.771646803263702830e-01,
        3.952210451791832724e-01, 5.521779457399671465e-01,
        7.159762318066181797e-01, 1.978044434381087679e-01,
        4.674982805512734041e-01, 4.766888141551791080e-01,
        3.189812312602344768e-01, 8.065228448784499404e-01,
        4.635132091735049698e-01, 3.264258382827074367e-01,
        1.381282800525798771e-01, 6.145031483819434204e-01,
        5.826515763567299278e-01, 3.398389494732371729e-01,
        5.271373108388693884e-01, 2.285481325383386109e-01,
        3.880773203008054395e-01, 2.414073498971948672e-01,
        1.475240603879532930e-01, 6.930749347257856297e-01,
        4.730701460583680573e-01, 3.587065382239245093e-01,
        7.858319932998522050e-01, 2.820549266844545322e-01,
        3.258682761353004498e-01, 2.316067257264315948e-01,
        1.112419399267459696e-01, 3.712852414794622358e-01,
        5.350667524638885730e-02, 9.328027403187377775e-01,
        1.771646803263702830e-01, 5.901165057379083034e-01,
    };
    const auto sparse = fromDense<double, CPUMem>(dense, num_rows);
    const auto m = sparse.getView();

    static constexpr size_t len_scratch = 1;
    using T = double;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(num_rows, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, num_rows, len_scratch);

    s->candidate.data()[0] = 2195319283;

    auto min_row = -1;
    auto min_value = std::numeric_limits<double>::max();
    for (auto row = 0; row < num_rows; row++) {
        auto dot = [](auto a, auto b) {
            auto val = 0.0;
            for (auto i = 0; i < num_rows; i++) {
                val += a[i] * b[i];
            }
            return val;
        };

        mx(m, s);
        const auto before = dot(s->candidate, s->rows);

        s->candidate.flip(row);
        mx(m, s);
        const auto delta = dot(s->candidate, s->rows) - before;
        s->candidate.flip(row);

        if (delta < min_value) {
            min_value = delta;
            min_row = row;
        }
    }

    // Need to compute the y values
    mx(m, s);

    auto mr = 0u;
    const auto negative_minimum = minimumRow(m, s, mr);
    assert(negative_minimum);
    assert(min_row == mr);
    assert(abs(min_value - s->scratch_values[0]) < 1e-6);
}

void testUpdateXY() {
    std::printf("Testing update xy\n");

    static constexpr uint32_t num_rows = 32;
    std::vector<double> dense{
        5.942730528399744472e-01, 4.943969860436798758e-01,
        4.450847693527698601e-01, 8.767649740877209164e-01,
        4.054333830561835383e-01, 4.999222828511122874e-01,
        3.826815354975575123e-01, 3.340722083247833485e-01,
        6.279596773249214170e-01, 2.251549829171287098e-01,
        1.986545444226572865e-01, 9.357747070377553378e-01,
        6.326340120830891145e-01, 3.311346730519129644e-01,
        6.264076347834319769e-01, 9.724832044302037515e-01,
        6.297193178362305854e-01, 6.212828603028799357e-01,
        7.625446368329245050e-01, 4.541757768365274894e-01,
        6.171061403261197675e-01, 5.744577419942482610e-01,
        3.305157842807399105e-01, 5.865066865935431029e-01,
        5.407337641947700391e-01, 3.286277894440371439e-01,
        6.293241535086291361e-01, 5.150808254926644292e-01,
        6.416008274184521465e-01, 7.604218143133705254e-01,
        5.636522280341318414e-01, 3.952210451791832724e-01,
        4.943969860436798758e-01, 8.839765516369791909e-01,
        4.963480764744764850e-01, 4.322560509677699780e-01,
        5.891456477769203559e-01, 3.542100204745523007e-01,
        2.513125533926385824e-01, 5.786661318221772987e-01,
        5.140307620576374248e-01, 2.552217915853447483e-01,
        4.718757721947782757e-01, 6.524329920689263540e-01,
        6.110142977860718583e-01, 8.302779656400374186e-01,
        4.976242904890635366e-01, 6.535386503902147481e-01,
        6.395210782684976891e-01, 6.261694891809495012e-01,
        1.997296043516126329e-01, 5.045586184862647094e-01,
        7.517533510680312059e-01, 2.837580557029898420e-01,
        2.022808704433795568e-01, 4.572869495750678803e-01,
        4.815566695927993579e-01, 5.560696585985764884e-01,
        8.786866809353743868e-01, 5.038295870697994117e-01,
        5.649640967350475496e-01, 4.742825862332017417e-01,
        7.164651084728732577e-01, 5.521779457399671465e-01,
        4.450847693527698601e-01, 4.963480764744764850e-01,
        8.568883185702296235e-01, 3.854359749981637329e-01,
        5.159381151909574470e-01, 8.773024095511317011e-01,
        1.267431281835304513e-01, 4.372885495191148886e-01,
        5.494978154982063101e-01, 7.114324700224785580e-01,
        5.990087412207660833e-01, 2.415530795431968247e-01,
        6.539151775414659973e-01, 5.210208082920830819e-02,
        2.500551692287381056e-01, 2.875962386398734361e-01,
        8.259139526806078546e-01, 5.173153024400112265e-01,
        1.758897943482978232e-01, 6.906483807494311344e-01,
        7.039503758408230949e-01, 6.438700025701311613e-01,
        6.911646804017608225e-01, 2.675741824812734038e-01,
        1.405614196540564964e-01, 8.094632716078467016e-01,
        4.044937875030812924e-01, 2.386852606608171889e-01,
        4.840104121101163059e-01, 4.546524631426674956e-01,
        3.672693654801370555e-01, 7.159762318066181797e-01,
        8.767649740877209164e-01, 4.322560509677699780e-01,
        3.854359749981637329e-01, 8.749737745763492835e-01,
        3.232139243393603589e-01, 4.312221866275817717e-01,
        6.207102928662378005e-01, 6.429245223938384601e-01,
        7.521796692743685231e-01, 6.014243396119718366e-01,
        1.464660076653684362e-01, 4.623653055472529694e-01,
        3.557671714096016791e-01, 6.106399047378208156e-01,
        6.906907064985643441e-01, 3.715065754206375304e-01,
        3.895206417387635511e-01, 1.014166571950221307e-01,
        5.073716511620915970e-01, 3.477304064969257702e-01,
        6.721696383401307706e-01, 1.968416453722319215e-01,
        6.840239321733381228e-01, 2.807061649652577984e-01,
        5.095390951204166186e-01, 2.040689674309519863e-01,
        2.953783946869132371e-01, 3.077466322938677279e-01,
        8.370281991472735550e-01, 4.808383964023238422e-01,
        5.897862311488909492e-01, 1.978044434381087679e-01,
        4.054333830561835383e-01, 5.891456477769203559e-01,
        5.159381151909574470e-01, 3.232139243393603589e-01,
        9.322317712421887004e-01, 6.287798486667510733e-01,
        5.591694416768362430e-01, 1.240280945925237299e-01,
        7.758917051092750761e-02, 7.336513928037191601e-01,
        2.773359007671116760e-01, 3.160014722964881173e-01,
        5.472523989244697518e-01, 7.843915512385901678e-01,
        6.776877568282506648e-01, 8.520945865241384976e-01,
        6.550491333650247938e-01, 7.907737087843041968e-02,
        3.739456960245226003e-01, 4.873977674442017682e-01,
        1.802440269967759412e-01, 3.381149784223742571e-01,
        4.143977567866309331e-01, 3.073991206370622065e-01,
        7.232264249796414024e-01, 4.721967861061472371e-01,
        1.562623442464528556e-01, 1.678654085532153006e-01,
        5.485630962822327650e-01, 3.637327975760900611e-01,
        3.652923141057710654e-01, 4.674982805512734041e-01,
        4.999222828511122874e-01, 3.542100204745523007e-01,
        8.773024095511317011e-01, 4.312221866275817717e-01,
        6.287798486667510733e-01, 4.379990663199319068e-01,
        6.872385824702857970e-01, 8.293915027436737919e-01,
        6.922267961630750310e-01, 4.513748935909246973e-01,
        7.034662111535228135e-01, 1.621875183616731109e-01,
        1.299086186926137199e-01, 4.256152303502194201e-01,
        9.423096988927985862e-01, 4.633196477352037879e-01,
        3.328675000855761401e-01, 5.185660705661583325e-01,
        2.328163623263246329e-01, 8.949451519926900911e-01,
        7.626210555635004607e-01, 3.548731050072273518e-01,
        2.759056859499416925e-01, 8.783249949131965995e-01,
        5.859595395856556088e-01, 3.722490855194764414e-01,
        6.274689208451870170e-01, 5.758212405197693506e-01,
        2.607256432545650982e-01, 3.051412228590866249e-01,
        6.883649840175515289e-01, 4.766888141551791080e-01,
        3.826815354975575123e-01, 2.513125533926385824e-01,
        1.267431281835304513e-01, 6.207102928662378005e-01,
        5.591694416768362430e-01, 6.872385824702857970e-01,
        3.749244706947130190e-01, 4.922683725265061816e-01,
        5.248061961972558809e-01, 7.001585459888165497e-01,
        5.726013512862310195e-01, 4.925099738372403779e-01,
        7.005780483960145633e-01, 5.489360985116982228e-01,
        4.974452153961542167e-01, 3.686994686501169349e-01,
        6.764431806878508091e-01, 6.246198376494729310e-01,
        2.963762832691390625e-01, 5.745133013133683075e-01,
        2.912616738137164263e-01, 2.837741438308066799e-01,
        6.453681651420253296e-01, 7.310054142036179758e-01,
        5.243364905374918727e-01, 3.466227696825535110e-01,
        3.842638347839034685e-01, 5.434913761988746650e-01,
        1.877520541587662239e-01, 3.360834810514809479e-01,
        8.015964376939536118e-01, 3.189812312602344768e-01,
        3.340722083247833485e-01, 5.786661318221772987e-01,
        4.372885495191148886e-01, 6.429245223938384601e-01,
        1.240280945925237299e-01, 8.293915027436737919e-01,
        4.922683725265061816e-01, 5.736814547993476232e-01,
        1.562426236707604166e-01, 5.016960343918893672e-01,
        2.130939800106741444e-01, 5.965287922826330025e-01,
        4.766528974477544089e-01, 2.725487742442959105e-01,
        2.308677911562382334e-01, 3.509091331202338071e-01,
        5.542727479308034999e-01, 3.973596760397400951e-01,
        6.016640607626024817e-01, 2.792668271963044124e-01,
        5.551061207796383901e-01, 3.915284817552658336e-01,
        3.280811919069630544e-01, 5.977762206584760207e-01,
        3.859581433064402933e-01, 2.983365161059861603e-01,
        2.709214565458348267e-01, 8.410441295771762249e-01,
        5.630846030498675159e-01, 6.305074057690724931e-01,
        6.252837921649689878e-01, 8.065228448784499404e-01,
        6.279596773249214170e-01, 5.140307620576374248e-01,
        5.494978154982063101e-01, 7.521796692743685231e-01,
        7.758917051092750761e-02, 6.922267961630750310e-01,
        5.248061961972558809e-01, 1.562426236707604166e-01,
        8.982539211291831194e-01, 4.405370466481199898e-01,
        1.185747923505909851e-01, 4.386358193751147549e-01,
        5.897684559728335607e-01, 4.515716428284702877e-01,
        6.608118370995663682e-01, 8.754850973831298511e-01,
        3.117583130563129634e-01, 4.105587448256445282e-01,
        4.783448264312469833e-01, 2.367487470763807167e-01,
        5.438586206873496920e-01, 2.235948712831211105e-01,
        4.404531110157927087e-01, 7.926843623313194476e-01,
        7.952918023015468352e-01, 2.703205541134393042e-01,
        2.800016560127155385e-01, 7.773547473524289320e-01,
        4.422574570005935457e-01, 4.774009607729517990e-01,
        3.706074542128293126e-01, 4.635132091735049698e-01,
        2.251549829171287098e-01, 2.552217915853447483e-01,
        7.114324700224785580e-01, 6.014243396119718366e-01,
        7.336513928037191601e-01, 4.513748935909246973e-01,
        7.001585459888165497e-01, 5.016960343918893672e-01,
        4.405370466481199898e-01, 9.115625979886382568e-01,
        3.647057638793629875e-01, 8.916875674279483022e-01,
        2.094917241940290054e-01, 4.345103923311356420e-01,
        2.635580320270904942e-01, 6.733259532904054545e-01,
        6.071266535673753850e-01, 7.708564206076973235e-01,
        4.858129102161677371e-01, 5.873593877960807674e-01,
        3.340523599795570675e-01, 5.947531792726137301e-01,
        5.362673065846128573e-01, 1.957111016661866598e-01,
        5.149448584676685758e-01, 6.990699397656017222e-01,
        6.696457214591200469e-01, 4.084264814999930548e-01,
        8.987138894628926566e-01, 4.776590636345899310e-01,
        5.439251295300220335e-01, 3.264258382827074367e-01,
        1.986545444226572865e-01, 4.718757721947782757e-01,
        5.990087412207660833e-01, 1.464660076653684362e-01,
        2.773359007671116760e-01, 7.034662111535228135e-01,
        5.726013512862310195e-01, 2.130939800106741444e-01,
        1.185747923505909851e-01, 3.647057638793629875e-01,
        2.909342658715992069e-01, 5.318411879227129546e-01,
        1.175773406492504614e-01, 2.138300894127770357e-01,
        4.893537700964927795e-01, 7.858857237395189266e-01,
        4.275399249558593517e-01, 3.664229474907982342e-01,
        6.364172404685399798e-01, 5.530114105035470740e-01,
        6.102877295738395880e-01, 5.148786249816370564e-01,
        4.837587653144975741e-01, 4.935089085733792569e-01,
        4.832429769887987003e-01, 3.498528104258672999e-01,
        4.914548111651459994e-01, 4.104621296442947376e-01,
        3.615806610660072806e-01, 5.550907601722524509e-01,
        1.444992478935794300e-01, 1.381282800525798771e-01,
        9.357747070377553378e-01, 6.524329920689263540e-01,
        2.415530795431968247e-01, 4.623653055472529694e-01,
        3.160014722964881173e-01, 1.621875183616731109e-01,
        4.925099738372403779e-01, 5.965287922826330025e-01,
        4.386358193751147549e-01, 8.916875674279483022e-01,
        5.318411879227129546e-01, 8.452350856735054707e-01,
        3.962865822221317558e-02, 5.373477491083109570e-01,
        7.952866956627296924e-01, 9.607358599352761042e-02,
        4.777863913702102838e-01, 5.484713516926489341e-01,
        8.256261730230812779e-02, 2.567912243524657079e-01,
        4.827207359360733974e-01, 5.900235818695159784e-01,
        4.931761243694498531e-01, 2.419249442605224676e-01,
        8.580397672248246677e-02, 5.446046217641256071e-01,
        4.857335938497409633e-01, 1.463192617957400077e-01,
        6.917594056172897687e-01, 7.037594686541170930e-01,
        5.026419244326776337e-01, 6.145031483819434204e-01,
        6.326340120830891145e-01, 6.110142977860718583e-01,
        6.539151775414659973e-01, 3.557671714096016791e-01,
        5.472523989244697518e-01, 1.299086186926137199e-01,
        7.005780483960145633e-01, 4.766528974477544089e-01,
        5.897684559728335607e-01, 2.094917241940290054e-01,
        1.175773406492504614e-01, 3.962865822221317558e-02,
        5.101887555650711503e-01, 8.388645943456588538e-01,
        1.385701713461788831e-01, 7.933892009522214295e-01,
        3.677912693301362834e-01, 5.291534772698345268e-01,
        6.671412967868683985e-01, 2.616025228650604162e-01,
        4.293981405046170541e-01, 6.570621668321373621e-01,
        7.892323388258859485e-01, 9.191663814122796872e-01,
        3.625177758308810727e-01, 8.057967454654795247e-01,
        7.041136329168252717e-01, 7.273662913895683202e-01,
        8.480503831625103572e-01, 4.250273029196012242e-01,
        7.986383870153213049e-01, 5.826515763567299278e-01,
        3.311346730519129644e-01, 8.302779656400374186e-01,
        5.210208082920830819e-02, 6.106399047378208156e-01,
        7.843915512385901678e-01, 4.256152303502194201e-01,
        5.489360985116982228e-01, 2.725487742442959105e-01,
        4.515716428284702877e-01, 4.345103923311356420e-01,
        2.138300894127770357e-01, 5.373477491083109570e-01,
        8.388645943456588538e-01, 5.332373658681816009e-01,
        6.585321895225719757e-01, 5.748151499816529508e-01,
        7.471077453424004311e-01, 2.862236010435844080e-01,
        2.734035814932620490e-01, 6.475913206721896076e-01,
        5.478776123565896050e-01, 3.755720568794032599e-01,
        6.421451294572846358e-01, 4.532383579360005355e-01,
        8.171242771634733559e-01, 6.808532396001474307e-01,
        2.974641972958305125e-01, 5.023114034246628501e-01,
        8.882022539009262196e-01, 1.518244468239161593e-01,
        7.089351274870658859e-01, 3.398389494732371729e-01,
        6.264076347834319769e-01, 4.976242904890635366e-01,
        2.500551692287381056e-01, 6.906907064985643441e-01,
        6.776877568282506648e-01, 9.423096988927985862e-01,
        4.974452153961542167e-01, 2.308677911562382334e-01,
        6.608118370995663682e-01, 2.635580320270904942e-01,
        4.893537700964927795e-01, 7.952866956627296924e-01,
        1.385701713461788831e-01, 6.585321895225719757e-01,
        9.464544860108432545e-01, 5.076013333086091261e-01,
        3.488269611862402919e-01, 4.554763148296480657e-01,
        1.631210159489470679e-01, 6.443048372958810610e-01,
        1.405657260863322766e-01, 4.403971185979216330e-01,
        6.768660408616997692e-01, 5.139971756749115439e-01,
        4.858115601086532287e-01, 5.576752264905897594e-01,
        5.338113645373008254e-01, 4.561675319362792913e-01,
        6.977786457539357778e-01, 5.115508308831979711e-01,
        7.444203236230797494e-01, 5.271373108388693884e-01,
        9.724832044302037515e-01, 6.535386503902147481e-01,
        2.875962386398734361e-01, 3.715065754206375304e-01,
        8.520945865241384976e-01, 4.633196477352037879e-01,
        3.686994686501169349e-01, 3.509091331202338071e-01,
        8.754850973831298511e-01, 6.733259532904054545e-01,
        7.858857237395189266e-01, 9.607358599352761042e-02,
        7.933892009522214295e-01, 5.748151499816529508e-01,
        5.076013333086091261e-01, 1.808347239226427705e-01,
        2.867348749238212147e-01, 3.873353821038852951e-01,
        4.702185341978043498e-01, 2.720961749868592294e-01,
        3.788858596174674020e-01, 6.326130115836006151e-01,
        4.679461260184809568e-01, 5.773275550634641151e-01,
        4.873824984100982305e-01, 1.690649920310376420e-01,
        8.324909911429634324e-01, 7.042945034842507113e-01,
        4.337093419822924401e-01, 7.129318851352177688e-01,
        5.361882841921545850e-01, 2.285481325383386109e-01,
        6.297193178362305854e-01, 6.395210782684976891e-01,
        8.259139526806078546e-01, 3.895206417387635511e-01,
        6.550491333650247938e-01, 3.328675000855761401e-01,
        6.764431806878508091e-01, 5.542727479308034999e-01,
        3.117583130563129634e-01, 6.071266535673753850e-01,
        4.275399249558593517e-01, 4.777863913702102838e-01,
        3.677912693301362834e-01, 7.471077453424004311e-01,
        3.488269611862402919e-01, 2.867348749238212147e-01,
        1.917099615992804429e-01, 8.445563662332199462e-01,
        6.066582128567695742e-01, 5.274337257639498677e-01,
        8.120352579317666741e-01, 6.290877286628624443e-01,
        5.282860359030407960e-01, 5.099931002577233752e-01,
        2.921759482900123661e-01, 5.897259619345247561e-01,
        5.753106334056373727e-01, 1.223589545676667667e-02,
        4.996207960252895819e-01, 1.540554721363839308e-01,
        2.543974685949278447e-01, 3.880773203008054395e-01,
        6.212828603028799357e-01, 6.261694891809495012e-01,
        5.173153024400112265e-01, 1.014166571950221307e-01,
        7.907737087843041968e-02, 5.185660705661583325e-01,
        6.246198376494729310e-01, 3.973596760397400951e-01,
        4.105587448256445282e-01, 7.708564206076973235e-01,
        3.664229474907982342e-01, 5.484713516926489341e-01,
        5.291534772698345268e-01, 2.862236010435844080e-01,
        4.554763148296480657e-01, 3.873353821038852951e-01,
        8.445563662332199462e-01, 6.113458882036935105e-01,
        6.872094630627016976e-01, 5.527220144550675229e-01,
        2.561247778679106579e-01, 7.602255922063401172e-01,
        6.722666170949145314e-01, 2.706878052765134823e-01,
        4.627608591024383045e-01, 5.368030626479711742e-01,
        8.347542409242622030e-01, 4.362657156973697159e-01,
        4.260087258393612797e-01, 5.095700208705697953e-01,
        8.150766393001667165e-01, 2.414073498971948672e-01,
        7.625446368329245050e-01, 1.997296043516126329e-01,
        1.758897943482978232e-01, 5.073716511620915970e-01,
        3.739456960245226003e-01, 2.328163623263246329e-01,
        2.963762832691390625e-01, 6.016640607626024817e-01,
        4.783448264312469833e-01, 4.858129102161677371e-01,
        6.364172404685399798e-01, 8.256261730230812779e-02,
        6.671412967868683985e-01, 2.734035814932620490e-01,
        1.631210159489470679e-01, 4.702185341978043498e-01,
        6.066582128567695742e-01, 6.872094630627016976e-01,
        6.724606038203506664e-01, 3.004015448341296191e-02,
        7.360732174576269937e-01, 1.591323714832026393e-01,
        1.466659554629596851e-01, 6.667993131287217601e-01,
        3.262064694356863748e-01, 1.597246155315403260e-01,
        2.766703654134595181e-01, 7.303918901395488605e-01,
        5.606909484254393172e-01, 7.340912554781940935e-01,
        7.887062016116763719e-01, 1.475240603879532930e-01,
        4.541757768365274894e-01, 5.045586184862647094e-01,
        6.906483807494311344e-01, 3.477304064969257702e-01,
        4.873977674442017682e-01, 8.949451519926900911e-01,
        5.745133013133683075e-01, 2.792668271963044124e-01,
        2.367487470763807167e-01, 5.873593877960807674e-01,
        5.530114105035470740e-01, 2.567912243524657079e-01,
        2.616025228650604162e-01, 6.475913206721896076e-01,
        6.443048372958810610e-01, 2.720961749868592294e-01,
        5.274337257639498677e-01, 5.527220144550675229e-01,
        3.004015448341296191e-02, 3.826076967162970188e-01,
        5.287561763167744067e-01, 1.634994590737719466e-01,
        1.713420584260277324e-01, 3.447072465462652224e-01,
        5.457102603855870093e-01, 5.292935828480128668e-01,
        6.672249039852735653e-01, 6.770670841375776572e-01,
        7.985380147652698657e-01, 7.927029694578043850e-01,
        8.676927323242851209e-01, 6.930749347257856297e-01,
        6.171061403261197675e-01, 7.517533510680312059e-01,
        7.039503758408230949e-01, 6.721696383401307706e-01,
        1.802440269967759412e-01, 7.626210555635004607e-01,
        2.912616738137164263e-01, 5.551061207796383901e-01,
        5.438586206873496920e-01, 3.340523599795570675e-01,
        6.102877295738395880e-01, 4.827207359360733974e-01,
        4.293981405046170541e-01, 5.478776123565896050e-01,
        1.405657260863322766e-01, 3.788858596174674020e-01,
        8.120352579317666741e-01, 2.561247778679106579e-01,
        7.360732174576269937e-01, 5.287561763167744067e-01,
        9.313542441945829031e-01, 5.445963908065096781e-01,
        3.088273570797490652e-01, 7.008749547186543527e-01,
        8.388503083083147516e-01, 7.502248506982782672e-01,
        5.274910500250303835e-01, 2.685711450284870572e-01,
        3.678040249306465670e-01, 6.627257645049364765e-01,
        5.455781389153636640e-01, 4.730701460583680573e-01,
        5.744577419942482610e-01, 2.837580557029898420e-01,
        6.438700025701311613e-01, 1.968416453722319215e-01,
        3.381149784223742571e-01, 3.548731050072273518e-01,
        2.837741438308066799e-01, 3.915284817552658336e-01,
        2.235948712831211105e-01, 5.947531792726137301e-01,
        5.148786249816370564e-01, 5.900235818695159784e-01,
        6.570621668321373621e-01, 3.755720568794032599e-01,
        4.403971185979216330e-01, 6.326130115836006151e-01,
        6.290877286628624443e-01, 7.602255922063401172e-01,
        1.591323714832026393e-01, 1.634994590737719466e-01,
        5.445963908065096781e-01, 1.307189975584230890e-01,
        6.623184656337952614e-01, 8.402482668101369789e-01,
        3.437274117669181228e-01, 3.332203055789415003e-01,
        7.083860298284023749e-01, 7.713667311735235010e-01,
        4.773328061036896663e-01, 6.735691603470150834e-01,
        6.464152072686581985e-01, 3.587065382239245093e-01,
        3.305157842807399105e-01, 2.022808704433795568e-01,
        6.911646804017608225e-01, 6.840239321733381228e-01,
        4.143977567866309331e-01, 2.759056859499416925e-01,
        6.453681651420253296e-01, 3.280811919069630544e-01,
        4.404531110157927087e-01, 5.362673065846128573e-01,
        4.837587653144975741e-01, 4.931761243694498531e-01,
        7.892323388258859485e-01, 6.421451294572846358e-01,
        6.768660408616997692e-01, 4.679461260184809568e-01,
        5.282860359030407960e-01, 6.722666170949145314e-01,
        1.466659554629596851e-01, 1.713420584260277324e-01,
        3.088273570797490652e-01, 6.623184656337952614e-01,
        8.976557988799334087e-01, 5.570971414121306253e-01,
        5.704906664708839781e-01, 5.575914381621859262e-01,
        1.495267112509867657e-01, 4.348441593782854664e-01,
        1.575099408742601237e-01, 6.191150916713199504e-01,
        5.402203502477884722e-01, 7.858319932998522050e-01,
        5.865066865935431029e-01, 4.572869495750678803e-01,
        2.675741824812734038e-01, 2.807061649652577984e-01,
        3.073991206370622065e-01, 8.783249949131965995e-01,
        7.310054142036179758e-01, 5.977762206584760207e-01,
        7.926843623313194476e-01, 1.957111016661866598e-01,
        4.935089085733792569e-01, 2.419249442605224676e-01,
        9.191663814122796872e-01, 4.532383579360005355e-01,
        5.139971756749115439e-01, 5.773275550634641151e-01,
        5.099931002577233752e-01, 2.706878052765134823e-01,
        6.667993131287217601e-01, 3.447072465462652224e-01,
        7.008749547186543527e-01, 8.402482668101369789e-01,
        5.570971414121306253e-01, 4.743209705311834945e-01,
        6.118277198667143590e-01, 7.119048904356644059e-01,
        7.239568725709978336e-01, 5.530799695744582634e-01,
        3.318513435996138794e-01, 3.629063139463800658e-01,
        3.740547205781150075e-01, 2.820549266844545322e-01,
        5.407337641947700391e-01, 4.815566695927993579e-01,
        1.405614196540564964e-01, 5.095390951204166186e-01,
        7.232264249796414024e-01, 5.859595395856556088e-01,
        5.243364905374918727e-01, 3.859581433064402933e-01,
        7.952918023015468352e-01, 5.149448584676685758e-01,
        4.832429769887987003e-01, 8.580397672248246677e-02,
        3.625177758308810727e-01, 8.171242771634733559e-01,
        4.858115601086532287e-01, 4.873824984100982305e-01,
        2.921759482900123661e-01, 4.627608591024383045e-01,
        3.262064694356863748e-01, 5.457102603855870093e-01,
        8.388503083083147516e-01, 3.437274117669181228e-01,
        5.704906664708839781e-01, 6.118277198667143590e-01,
        8.711179137502881309e-01, 7.184014796962014948e-01,
        4.724342063419213478e-01, 5.166041043337659122e-01,
        7.257631194152415199e-01, 7.679763514809700986e-01,
        8.742869931502154079e-01, 3.258682761353004498e-01,
        3.286277894440371439e-01, 5.560696585985764884e-01,
        8.094632716078467016e-01, 2.040689674309519863e-01,
        4.721967861061472371e-01, 3.722490855194764414e-01,
        3.466227696825535110e-01, 2.983365161059861603e-01,
        2.703205541134393042e-01, 6.990699397656017222e-01,
        3.498528104258672999e-01, 5.446046217641256071e-01,
        8.057967454654795247e-01, 6.808532396001474307e-01,
        5.576752264905897594e-01, 1.690649920310376420e-01,
        5.897259619345247561e-01, 5.368030626479711742e-01,
        1.597246155315403260e-01, 5.292935828480128668e-01,
        7.502248506982782672e-01, 3.332203055789415003e-01,
        5.575914381621859262e-01, 7.119048904356644059e-01,
        7.184014796962014948e-01, 6.127840721328589035e-01,
        6.229188508692040660e-01, 7.155418536482810454e-01,
        5.327263496325558290e-01, 5.669312515119238061e-01,
        9.059394928272801462e-02, 2.316067257264315948e-01,
        6.293241535086291361e-01, 8.786866809353743868e-01,
        4.044937875030812924e-01, 2.953783946869132371e-01,
        1.562623442464528556e-01, 6.274689208451870170e-01,
        3.842638347839034685e-01, 2.709214565458348267e-01,
        2.800016560127155385e-01, 6.696457214591200469e-01,
        4.914548111651459994e-01, 4.857335938497409633e-01,
        7.041136329168252717e-01, 2.974641972958305125e-01,
        5.338113645373008254e-01, 8.324909911429634324e-01,
        5.753106334056373727e-01, 8.347542409242622030e-01,
        2.766703654134595181e-01, 6.672249039852735653e-01,
        5.274910500250303835e-01, 7.083860298284023749e-01,
        1.495267112509867657e-01, 7.239568725709978336e-01,
        4.724342063419213478e-01, 6.229188508692040660e-01,
        2.381309455246360951e-01, 6.493171621403277527e-01,
        5.759581749112908655e-01, 6.982238003204181975e-01,
        4.642472487020705696e-01, 1.112419399267459696e-01,
        5.150808254926644292e-01, 5.038295870697994117e-01,
        2.386852606608171889e-01, 3.077466322938677279e-01,
        1.678654085532153006e-01, 5.758212405197693506e-01,
        5.434913761988746650e-01, 8.410441295771762249e-01,
        7.773547473524289320e-01, 4.084264814999930548e-01,
        4.104621296442947376e-01, 1.463192617957400077e-01,
        7.273662913895683202e-01, 5.023114034246628501e-01,
        4.561675319362792913e-01, 7.042945034842507113e-01,
        1.223589545676667667e-02, 4.362657156973697159e-01,
        7.303918901395488605e-01, 6.770670841375776572e-01,
        2.685711450284870572e-01, 7.713667311735235010e-01,
        4.348441593782854664e-01, 5.530799695744582634e-01,
        5.166041043337659122e-01, 7.155418536482810454e-01,
        6.493171621403277527e-01, 8.344297159318466717e-01,
        8.460787220021159794e-01, 5.014395330405199136e-01,
        5.815929865481380689e-01, 3.712852414794622358e-01,
        6.416008274184521465e-01, 5.649640967350475496e-01,
        4.840104121101163059e-01, 8.370281991472735550e-01,
        5.485630962822327650e-01, 2.607256432545650982e-01,
        1.877520541587662239e-01, 5.630846030498675159e-01,
        4.422574570005935457e-01, 8.987138894628926566e-01,
        3.615806610660072806e-01, 6.917594056172897687e-01,
        8.480503831625103572e-01, 8.882022539009262196e-01,
        6.977786457539357778e-01, 4.337093419822924401e-01,
        4.996207960252895819e-01, 4.260087258393612797e-01,
        5.606909484254393172e-01, 7.985380147652698657e-01,
        3.678040249306465670e-01, 4.773328061036896663e-01,
        1.575099408742601237e-01, 3.318513435996138794e-01,
        7.257631194152415199e-01, 5.327263496325558290e-01,
        5.759581749112908655e-01, 8.460787220021159794e-01,
        5.404553878952820245e-01, 4.023816964726366630e-01,
        5.974548191483245452e-01, 5.350667524638885730e-02,
        7.604218143133705254e-01, 4.742825862332017417e-01,
        4.546524631426674956e-01, 4.808383964023238422e-01,
        3.637327975760900611e-01, 3.051412228590866249e-01,
        3.360834810514809479e-01, 6.305074057690724931e-01,
        4.774009607729517990e-01, 4.776590636345899310e-01,
        5.550907601722524509e-01, 7.037594686541170930e-01,
        4.250273029196012242e-01, 1.518244468239161593e-01,
        5.115508308831979711e-01, 7.129318851352177688e-01,
        1.540554721363839308e-01, 5.095700208705697953e-01,
        7.340912554781940935e-01, 7.927029694578043850e-01,
        6.627257645049364765e-01, 6.735691603470150834e-01,
        6.191150916713199504e-01, 3.629063139463800658e-01,
        7.679763514809700986e-01, 5.669312515119238061e-01,
        6.982238003204181975e-01, 5.014395330405199136e-01,
        4.023816964726366630e-01, 4.632632042039820375e-01,
        1.501963564798944328e-01, 9.328027403187377775e-01,
        5.636522280341318414e-01, 7.164651084728732577e-01,
        3.672693654801370555e-01, 5.897862311488909492e-01,
        3.652923141057710654e-01, 6.883649840175515289e-01,
        8.015964376939536118e-01, 6.252837921649689878e-01,
        3.706074542128293126e-01, 5.439251295300220335e-01,
        1.444992478935794300e-01, 5.026419244326776337e-01,
        7.986383870153213049e-01, 7.089351274870658859e-01,
        7.444203236230797494e-01, 5.361882841921545850e-01,
        2.543974685949278447e-01, 8.150766393001667165e-01,
        7.887062016116763719e-01, 8.676927323242851209e-01,
        5.455781389153636640e-01, 6.464152072686581985e-01,
        5.402203502477884722e-01, 3.740547205781150075e-01,
        8.742869931502154079e-01, 9.059394928272801462e-02,
        4.642472487020705696e-01, 5.815929865481380689e-01,
        5.974548191483245452e-01, 1.501963564798944328e-01,
        7.077107420870329957e-01, 1.771646803263702830e-01,
        3.952210451791832724e-01, 5.521779457399671465e-01,
        7.159762318066181797e-01, 1.978044434381087679e-01,
        4.674982805512734041e-01, 4.766888141551791080e-01,
        3.189812312602344768e-01, 8.065228448784499404e-01,
        4.635132091735049698e-01, 3.264258382827074367e-01,
        1.381282800525798771e-01, 6.145031483819434204e-01,
        5.826515763567299278e-01, 3.398389494732371729e-01,
        5.271373108388693884e-01, 2.285481325383386109e-01,
        3.880773203008054395e-01, 2.414073498971948672e-01,
        1.475240603879532930e-01, 6.930749347257856297e-01,
        4.730701460583680573e-01, 3.587065382239245093e-01,
        7.858319932998522050e-01, 2.820549266844545322e-01,
        3.258682761353004498e-01, 2.316067257264315948e-01,
        1.112419399267459696e-01, 3.712852414794622358e-01,
        5.350667524638885730e-02, 9.328027403187377775e-01,
        1.771646803263702830e-01, 5.901165057379083034e-01,
    };
    const auto sparse = fromDense<double, CPUMem>(dense, num_rows);
    const auto m = sparse.getView();

    static constexpr size_t len_scratch = 1;
    using T = double;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(num_rows, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, num_rows, len_scratch);

    s->candidate.data()[0] = 2195319283;

    const auto minrow = 0;
    const auto oldbit = s->candidate[minrow];
    s->candidate.flip(minrow);
    mx(m, s);
    const std::vector<double> oldy(s->rows, s->rows + num_rows);
    s->candidate.flip(minrow);

    // Redo the computation to y
    mx(m, s);

    updateXY(m, s, minrow);

    assert((oldbit ^ s->candidate[minrow]) == 1);
    assert(s->candidate.data()[0] != 2195319283);
    s->candidate.flip(minrow);
    assert(s->candidate.data()[0] == 2195319283);

    for (auto i = 0; i < oldy.size(); i++) {
        assert(abs(s->rows[i] - oldy[i]) < 1e-5);
    }
}

void testSwapping() {
    std::printf("Testing swapping\n");

    static constexpr size_t len_data = 33;
    static constexpr size_t len_scratch = 1;
    using T = double;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(len_data, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, len_data, len_scratch);

    s->candidate.data()[0] = 666;
    s->best_candidate.data()[0] = 16;

    s->swapCandidates();

    assert(s->candidate.data()[0] == 16);
    assert(s->best_candidate.data()[0] == 666);
}

void testBlockSearch() {
    std::printf("Testing blockSearch\n");

    static constexpr size_t num_rows = 32;
    static constexpr size_t len_scratch = 1;
    using T = float;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(num_rows, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, num_rows, len_scratch);

    std::vector<float> dense{
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.232895283264147546e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.627865228770913220e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.575883075459874050e-01,
        0.000000000000000000e+00,  6.281514945696407004e-01,
        -4.217328051830958602e-01, 0.000000000000000000e+00,
        5.910127532744389178e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.790355854774167810e-03,
        2.399035657032428936e-01,  5.250199835819158167e-02,
        -2.035554044705445431e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.501697497467295861e-02,
        -8.240040029758413098e-01, 4.867488052401565124e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.473701232363807456e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.444931828056330136e-02, 0.000000000000000000e+00,
        -3.001427301219831145e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.330649206177298538e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.575883075459874050e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.473701232363807456e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.718096360536883749e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.660942874272103964e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.717021325965639722e-02, -5.248309328882472258e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.821093812908759269e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.887095635332367571e-01,
        0.000000000000000000e+00,  6.281514945696407004e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.550213112602664811e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.647517004860979295e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.151925797152027142e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        8.859965928243378475e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.217328051830958602e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.718096360536883749e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.363097945018211909e-01,
        -4.315385988647291171e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.177985376072406609e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        6.563911360371292858e-01,  -6.500723857190968680e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.474346087339870603e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.178060956224650013e-01,  0.000000000000000000e+00,
        -1.914746094668813292e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.910127532744389178e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.587598326659406922e-01, -6.077811714737161308e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.789078659232718582e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.763317878129920580e-01,
        8.008688587847569984e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.059244962344520591e-02,
        3.464055624404833722e-01,  -3.111709284125441233e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -9.864123571925798029e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.647517004860979295e-01,
        3.363097945018211909e-01,  0.000000000000000000e+00,
        -6.077811714737161308e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.277810901685664469e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.207833461127837849e-01, 0.000000000000000000e+00,
        5.908138443118962080e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.633758035104645012e-01,
        -7.109600367501045515e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.645201802586591100e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.660942874272103964e-02, 0.000000000000000000e+00,
        -4.315385988647291171e-02, 6.563911360371292858e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.174809786964613245e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.206976921478641884e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.906731791546584898e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.878931772154205371e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.522882794387103722e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -6.500723857190968680e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.174809786964613245e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.068591291476598037e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.500083509961545047e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.789078659232718582e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.257910002004175354e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.583638046685115430e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.277810901685664469e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.938248632622524337e-01,  0.000000000000000000e+00,
        7.970094608366529165e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.874757870480507016e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.474346087339870603e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.068591291476598037e-01,
        7.257910002004175354e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.667447874380803441e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        8.197945593944377940e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.232895283264147546e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.717021325965639722e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -7.969005779536852963e-03,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.790355854774167810e-03,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.248309328882472258e-02, -5.151925797152027142e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.206976921478641884e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.184367225476927743e-02,
        0.000000000000000000e+00,  2.610972628118792827e-01,
        -2.321901900322242973e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.399035657032428936e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.207833461127837849e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.667447874380803441e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.522454692377209540e-01, 0.000000000000000000e+00,
        -7.807706424253757493e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.250199835819158167e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.270154459561219085e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.035554044705445431e-02,
        -3.444931828056330136e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  8.859965928243378475e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.908138443118962080e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.235940404425517336e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.319663660705574504e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.763317878129920580e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  6.500083509961545047e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -7.969005779536852963e-03, 6.184367225476927743e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.019801758935558134e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.001427301219831145e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.178060956224650013e-01,
        8.008688587847569984e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.938248632622524337e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.522454692377209540e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.362132403440559081e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.145824118212235510e-01,
        0.000000000000000000e+00,  4.872536693312274902e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.906731791546584898e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.610972628118792827e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        1.362132403440559081e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.594076925471877182e-01,
        1.561953419674908528e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.822357359135244437e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.914746094668813292e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        7.970094608366529165e-01,  8.197945593944377940e-02,
        0.000000000000000000e+00,  -2.321901900322242973e-02,
        -7.807706424253757493e-02, 0.000000000000000000e+00,
        -1.235940404425517336e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.003250079824384855e-02,
        9.155910346888727069e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.749643220520866738e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.821093812908759269e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.059244962344520591e-02, -3.633758035104645012e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.594076925471877182e-01,
        6.003250079824384855e-02,  0.000000000000000000e+00,
        -2.996100193096786768e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.464055624404833722e-01,  -7.109600367501045515e-02,
        -1.878931772154205371e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.561953419674908528e-01,
        9.155910346888727069e-01,  -2.996100193096786768e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.639079862139427135e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.330649206177298538e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.111709284125441233e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.270154459561219085e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.145824118212235510e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        6.469282406991374579e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -6.699200351591384495e-01,
        0.000000000000000000e+00,  3.790225991247342385e-01,
        0.000000000000000000e+00,  6.501697497467295861e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.645201802586591100e-01,
        -1.522882794387103722e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        4.872536693312274902e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.639079862139427135e-02,  0.000000000000000000e+00,
        -6.699200351591384495e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.240040029758413098e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -9.864123571925798029e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.874757870480507016e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.319663660705574504e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.469282406991374579e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        4.627865228770913220e-01,  4.867488052401565124e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        1.887095635332367571e-01,  0.000000000000000000e+00,
        -2.177985376072406609e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.583638046685115430e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.019801758935558134e-01,
        0.000000000000000000e+00,  3.822357359135244437e-01,
        1.749643220520866738e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.790225991247342385e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
    };

    const auto sparse = fromDense<float, CPUMem>(dense, num_rows);
    const auto m = sparse.getView();

    const auto res = blockSearch(m, s, [](auto *sd) {
        auto data = sd->candidate.data();
        for (uint32_t i = gpu::threadid();
             i < BitVector::requiredLength(sd->len_data);
             i += gpu::nthreads()) {
            data[i] = i;
        }
    });
    std::printf("%f\n", res);
    // x = 82337903
    // res = -0.115629
}

void testSearch() {
    std::printf("Testing search\n");

    static constexpr size_t num_rows = 32;
    static constexpr size_t len_scratch = 1;
    using T = float;
    using S = SearchData<T>;

    std::vector<uint8_t> data(S::memReq(num_rows, len_scratch), 0);
    Allocator allocator(data.data(), data.size());
    S *s = allocator.allocate<S>(1);
    *s = S(allocator, num_rows, len_scratch);

    s->best_candidate.data()[0] = 0xBEEFBEEF;

    std::vector<float> dense{
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.232895283264147546e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.627865228770913220e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.575883075459874050e-01,
        0.000000000000000000e+00,  6.281514945696407004e-01,
        -4.217328051830958602e-01, 0.000000000000000000e+00,
        5.910127532744389178e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.790355854774167810e-03,
        2.399035657032428936e-01,  5.250199835819158167e-02,
        -2.035554044705445431e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.501697497467295861e-02,
        -8.240040029758413098e-01, 4.867488052401565124e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.473701232363807456e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.444931828056330136e-02, 0.000000000000000000e+00,
        -3.001427301219831145e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.330649206177298538e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.575883075459874050e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.473701232363807456e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.718096360536883749e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.660942874272103964e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.717021325965639722e-02, -5.248309328882472258e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.821093812908759269e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.887095635332367571e-01,
        0.000000000000000000e+00,  6.281514945696407004e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.550213112602664811e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.647517004860979295e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.151925797152027142e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        8.859965928243378475e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.217328051830958602e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.718096360536883749e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.363097945018211909e-01,
        -4.315385988647291171e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.177985376072406609e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        6.563911360371292858e-01,  -6.500723857190968680e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.474346087339870603e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.178060956224650013e-01,  0.000000000000000000e+00,
        -1.914746094668813292e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.910127532744389178e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.587598326659406922e-01, -6.077811714737161308e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.789078659232718582e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.763317878129920580e-01,
        8.008688587847569984e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.059244962344520591e-02,
        3.464055624404833722e-01,  -3.111709284125441233e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -9.864123571925798029e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.647517004860979295e-01,
        3.363097945018211909e-01,  0.000000000000000000e+00,
        -6.077811714737161308e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.277810901685664469e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.207833461127837849e-01, 0.000000000000000000e+00,
        5.908138443118962080e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.633758035104645012e-01,
        -7.109600367501045515e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.645201802586591100e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.660942874272103964e-02, 0.000000000000000000e+00,
        -4.315385988647291171e-02, 6.563911360371292858e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.174809786964613245e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.206976921478641884e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.906731791546584898e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.878931772154205371e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.522882794387103722e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -6.500723857190968680e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.174809786964613245e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.068591291476598037e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.500083509961545047e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.789078659232718582e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.257910002004175354e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.583638046685115430e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.277810901685664469e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.938248632622524337e-01,  0.000000000000000000e+00,
        7.970094608366529165e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.874757870480507016e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.474346087339870603e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.068591291476598037e-01,
        7.257910002004175354e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.667447874380803441e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        8.197945593944377940e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.232895283264147546e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.717021325965639722e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -7.969005779536852963e-03,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.790355854774167810e-03,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.248309328882472258e-02, -5.151925797152027142e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.206976921478641884e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.184367225476927743e-02,
        0.000000000000000000e+00,  2.610972628118792827e-01,
        -2.321901900322242973e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.399035657032428936e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.207833461127837849e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.667447874380803441e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.522454692377209540e-01, 0.000000000000000000e+00,
        -7.807706424253757493e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.250199835819158167e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.270154459561219085e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.035554044705445431e-02,
        -3.444931828056330136e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  8.859965928243378475e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.908138443118962080e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.235940404425517336e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.319663660705574504e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.763317878129920580e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  6.500083509961545047e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -7.969005779536852963e-03, 6.184367225476927743e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.019801758935558134e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.001427301219831145e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.178060956224650013e-01,
        8.008688587847569984e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.938248632622524337e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.522454692377209540e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.362132403440559081e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.145824118212235510e-01,
        0.000000000000000000e+00,  4.872536693312274902e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.906731791546584898e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.610972628118792827e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        1.362132403440559081e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.594076925471877182e-01,
        1.561953419674908528e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.822357359135244437e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.914746094668813292e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        7.970094608366529165e-01,  8.197945593944377940e-02,
        0.000000000000000000e+00,  -2.321901900322242973e-02,
        -7.807706424253757493e-02, 0.000000000000000000e+00,
        -1.235940404425517336e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.003250079824384855e-02,
        9.155910346888727069e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.749643220520866738e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.821093812908759269e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.059244962344520591e-02, -3.633758035104645012e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.594076925471877182e-01,
        6.003250079824384855e-02,  0.000000000000000000e+00,
        -2.996100193096786768e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.464055624404833722e-01,  -7.109600367501045515e-02,
        -1.878931772154205371e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.561953419674908528e-01,
        9.155910346888727069e-01,  -2.996100193096786768e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.639079862139427135e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.330649206177298538e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.111709284125441233e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.270154459561219085e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.145824118212235510e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        6.469282406991374579e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -6.699200351591384495e-01,
        0.000000000000000000e+00,  3.790225991247342385e-01,
        0.000000000000000000e+00,  6.501697497467295861e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.645201802586591100e-01,
        -1.522882794387103722e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        4.872536693312274902e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.639079862139427135e-02,  0.000000000000000000e+00,
        -6.699200351591384495e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.240040029758413098e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -9.864123571925798029e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.874757870480507016e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.319663660705574504e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.469282406991374579e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        4.627865228770913220e-01,  4.867488052401565124e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        1.887095635332367571e-01,  0.000000000000000000e+00,
        -2.177985376072406609e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.583638046685115430e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.019801758935558134e-01,
        0.000000000000000000e+00,  3.822357359135244437e-01,
        1.749643220520866738e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.790225991247342385e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
    };

    const auto sparse = fromDense<float, CPUMem>(dense, num_rows);
    const auto m = sparse.getView();

    // Do computation
    const auto minimum = search(m, s, 1, [](auto *sd) {
        auto data = sd->candidate.data();
        for (uint32_t i = gpu::threadid();
             i < BitVector::requiredLength(sd->len_data);
             i += gpu::nthreads()) {
            data[i] = i;
        }
    });

    std::printf("%f, %u, %u\n", minimum, s->candidate.data()[0],
                s->best_candidate.data()[0]);
    assert(s->candidate.data()[0] == 0xBEEFBEEF);
    assert(s->best_candidate.data()[0] != 0xBEEFBEEF);
    // x = 82337903
    // res = -0.115629
}

void testSparseMatrix() {
    std::printf("Testing sparse matrix\n");

    constexpr static auto n = 4;
    std::vector<uint32_t> indptr{0, 2, 3, 4, 5};
    std::vector<uint32_t> indices{0, 2, 1, 2, 3};
    std::vector<float> data{11.0f, 13.0f, 22.0f, 33.0f, 44.0f};

    const SparseMatrix<float, CPUMem> mat(indptr, indices, data);
    const auto diagonal = mat.getView().diagonal;

    assert(diagonal[0] == 11.0f);
    assert(diagonal[1] == 22.0f);
    assert(diagonal[2] == 33.0f);
    assert(diagonal[3] == 44.0f);

    const auto dense = mat.getView().toDense();
    auto i = 0;
    for (auto d : dense) {
        const auto row = i / n + 1;
        const auto col = i % n + 1;
        if (row == col) {
            assert(d == static_cast<float>(row * 11.0f));
        } else if (row == 1 && col == 3) {
            assert(d == 13.0f);
        } else {
            assert(d == 0.0f);
        }
        std::cout << d << std::endl;
        i++;
    }
}

template <typename T, typename Op>
__global__ void warpReductionKernel(std::span<T> values, Op op) {
    auto value = threadIdx.x < values.size() ? values[threadIdx.x] : 0;
    value = gpu::warpReduce(value, op);
    if (threadIdx.x == 0) {
        values[0] = value;
    }
}

void testWarpReduction() {
    std::printf("Testing warp reduction\n");

    const uint32_t n = gpu::warpSize();
    auto mem = gpu::allocate(sizeof(double) * n);

    auto launchWarpReduction =
        []<typename T, typename Op>(std::span<T> values,
                                    const std::vector<T> &h_values, Op op) {
            gpu::memcpy(values.data(), h_values.data(), values.size_bytes());

            LAUNCH_KERNEL(warpReductionKernel, 1, values.size(), 0, 0, "",
                          values, op);

            T result = 0;
            gpu::memcpy(&result, values.data(), sizeof(T));
            T h_result = std::reduce(h_values.cbegin() + 1, h_values.cend(),
                                     h_values[0], op);

            std::cout << result << ", " << h_result << std::endl;

            assert(result == h_result);
        };

    launchWarpReduction(
        std::span(static_cast<uint32_t *>(mem), n),
        [&n]() {
            std::vector<uint32_t> values(n);
            std::iota(values.begin(), values.end(), 0);
            return values;
        }(),
        [](auto a, auto b) { return a + b; });

    launchWarpReduction(
        std::span(static_cast<float *>(mem), n),
        [&n]() {
            std::vector<float> values(n);
            std::generate(values.begin(), values.end(), [&n, i = 0]() mutable {
                return -static_cast<float>(n) / 2.0f + (i++);
            });
            return values;
        }(),
        [](auto a, auto b) { return a < b ? a : b; });

    gpu::free(mem);
}

template <typename T, typename Op>
__global__ void warpArgSearchKernel(std::span<T> values, uint32_t *indices,
                                    Op op) {
    auto value = threadIdx.x < values.size() ? values[threadIdx.x] : 0;
    auto index = -1;
    std::tie(value, index) = gpu::warpArgSearch(value, gpu::laneid(), op);
    if (threadIdx.x == 0) {
        values[0] = value;
        indices[0] = index;
    }
}

void testWarpArgSearch() {
    std::printf("Testing warp arg search\n");

    const uint32_t n = 29u;
    auto values = gpu::allocate(sizeof(float) * n);
    auto indices = static_cast<uint32_t *>(gpu::allocate(sizeof(uint32_t)));

    auto launchWarpArgSearch =
        []<typename T, typename Op>(std::span<T> values,
                                    const std::vector<T> &h_values,
                                    uint32_t *indices, Op op) {
            gpu::memcpy(values.data(), h_values.data(), values.size_bytes());

            LAUNCH_KERNEL(warpArgSearchKernel, 1, values.size(), 0, 0, "",
                          values, indices, op);

            T result = 0;
            uint32_t index = 0;
            gpu::memcpy(&result, values.data(), sizeof(T));
            gpu::memcpy(&index, indices, sizeof(uint32_t));

            T h_result = h_values[0];
            uint32_t j = 0;
            for (auto i = 1; i < h_values.size(); i++) {
                std::tie(h_result, j) = op(h_result, h_values[i], j, i);
            }

            auto ind = std::distance(
                h_values.begin(),
                std::min_element(h_values.begin(), h_values.end()));

            if (result != h_result || h_result != h_values[ind] || index != j ||
                index != ind) {
                std::cout << result << ", " << h_result << ", " << h_values[ind]
                          << std::endl;
                std::cout << index << ", " << j << ", " << ind << std::endl;
            }

            assert(result == h_result);
            assert(index == j);
        };

    auto argmin = [](auto a, auto b, auto i, auto j) {
        auto interpolate = [](auto s, auto a, auto b) {
            return s * a + static_cast<decltype(a)>(1 - s) * b;
        };

        // Avoid 'if' within warp by doing a linear interpolation between
        // the two endpoints with s either 0 or 1
        const auto s = static_cast<decltype(a)>(a < b);
        return std::make_pair(interpolate(s, a, b), interpolate(s, i, j));
    };

    std::mt19937 rng(11);

    auto generate = [&n, &rng](auto dist) {
        std::vector<float> values(n);
        std::generate(values.begin(), values.end(),
                      [&rng, &dist]() { return dist(rng); });

        return values;
    };

    // Run the thing 100 times with random values
    for (auto i = 0; i < 100; i++) {
        launchWarpArgSearch(std::span(static_cast<float *>(values), n),
                            generate(std::normal_distribution<float>(0, 2)),
                            indices, argmin);
    }

    // Run once with strictly positive values
    launchWarpArgSearch(
        std::span(static_cast<float *>(values), n),
        generate(std::uniform_real_distribution<float>(1.0f, 2.0f)), indices,
        argmin);

    gpu::free(values);
    gpu::free(indices);
}

void testGPUSearch() {
    std::printf("Testing search on GPU\n");

    static constexpr uint32_t num_rows = 32;
    static constexpr uint32_t num_blocks = 1024;
    static constexpr uint32_t num_threads = 32;
    std::vector<float> dense{
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.232895283264147546e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.627865228770913220e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.575883075459874050e-01,
        0.000000000000000000e+00,  6.281514945696407004e-01,
        -4.217328051830958602e-01, 0.000000000000000000e+00,
        5.910127532744389178e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.790355854774167810e-03,
        2.399035657032428936e-01,  5.250199835819158167e-02,
        -2.035554044705445431e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.501697497467295861e-02,
        -8.240040029758413098e-01, 4.867488052401565124e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.473701232363807456e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.444931828056330136e-02, 0.000000000000000000e+00,
        -3.001427301219831145e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.330649206177298538e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.575883075459874050e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.473701232363807456e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.718096360536883749e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.660942874272103964e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.717021325965639722e-02, -5.248309328882472258e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.821093812908759269e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.887095635332367571e-01,
        0.000000000000000000e+00,  6.281514945696407004e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.550213112602664811e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.647517004860979295e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.151925797152027142e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        8.859965928243378475e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.217328051830958602e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.718096360536883749e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.363097945018211909e-01,
        -4.315385988647291171e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.177985376072406609e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        6.563911360371292858e-01,  -6.500723857190968680e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.474346087339870603e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.178060956224650013e-01,  0.000000000000000000e+00,
        -1.914746094668813292e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.910127532744389178e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.587598326659406922e-01, -6.077811714737161308e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.789078659232718582e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.763317878129920580e-01,
        8.008688587847569984e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.059244962344520591e-02,
        3.464055624404833722e-01,  -3.111709284125441233e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -9.864123571925798029e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.647517004860979295e-01,
        3.363097945018211909e-01,  0.000000000000000000e+00,
        -6.077811714737161308e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.277810901685664469e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.207833461127837849e-01, 0.000000000000000000e+00,
        5.908138443118962080e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -3.633758035104645012e-01,
        -7.109600367501045515e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.645201802586591100e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -8.660942874272103964e-02, 0.000000000000000000e+00,
        -4.315385988647291171e-02, 6.563911360371292858e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.174809786964613245e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.206976921478641884e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.906731791546584898e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.878931772154205371e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.522882794387103722e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -6.500723857190968680e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.174809786964613245e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.068591291476598037e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.500083509961545047e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.789078659232718582e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.257910002004175354e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.583638046685115430e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.277810901685664469e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.938248632622524337e-01,  0.000000000000000000e+00,
        7.970094608366529165e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.874757870480507016e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.474346087339870603e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  7.068591291476598037e-01,
        7.257910002004175354e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.667447874380803441e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        8.197945593944377940e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -4.232895283264147546e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.717021325965639722e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -7.969005779536852963e-03,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.790355854774167810e-03,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.248309328882472258e-02, -5.151925797152027142e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.206976921478641884e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.184367225476927743e-02,
        0.000000000000000000e+00,  2.610972628118792827e-01,
        -2.321901900322242973e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.399035657032428936e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.207833461127837849e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -4.667447874380803441e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.522454692377209540e-01, 0.000000000000000000e+00,
        -7.807706424253757493e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.250199835819158167e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.270154459561219085e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -2.035554044705445431e-02,
        -3.444931828056330136e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  8.859965928243378475e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.908138443118962080e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.235940404425517336e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.319663660705574504e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.763317878129920580e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  6.500083509961545047e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -7.969005779536852963e-03, 6.184367225476927743e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.019801758935558134e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.001427301219831145e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.178060956224650013e-01,
        8.008688587847569984e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.938248632622524337e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -2.522454692377209540e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.362132403440559081e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -5.145824118212235510e-01,
        0.000000000000000000e+00,  4.872536693312274902e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.906731791546584898e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  2.610972628118792827e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        1.362132403440559081e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.594076925471877182e-01,
        1.561953419674908528e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.822357359135244437e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.914746094668813292e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        7.970094608366529165e-01,  8.197945593944377940e-02,
        0.000000000000000000e+00,  -2.321901900322242973e-02,
        -7.807706424253757493e-02, 0.000000000000000000e+00,
        -1.235940404425517336e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.003250079824384855e-02,
        9.155910346888727069e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.749643220520866738e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        2.821093812908759269e-02,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.059244962344520591e-02, -3.633758035104645012e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  4.594076925471877182e-01,
        6.003250079824384855e-02,  0.000000000000000000e+00,
        -2.996100193096786768e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.464055624404833722e-01,  -7.109600367501045515e-02,
        -1.878931772154205371e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.561953419674908528e-01,
        9.155910346888727069e-01,  -2.996100193096786768e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  3.639079862139427135e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.330649206177298538e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -3.111709284125441233e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  1.270154459561219085e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.145824118212235510e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        6.469282406991374579e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -6.699200351591384495e-01,
        0.000000000000000000e+00,  3.790225991247342385e-01,
        0.000000000000000000e+00,  6.501697497467295861e-02,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -1.645201802586591100e-01,
        -1.522882794387103722e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        4.872536693312274902e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.639079862139427135e-02,  0.000000000000000000e+00,
        -6.699200351591384495e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  -8.240040029758413098e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -9.864123571925798029e-02, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        5.874757870480507016e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -1.319663660705574504e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  6.469282406991374579e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        4.627865228770913220e-01,  4.867488052401565124e-01,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        1.887095635332367571e-01,  0.000000000000000000e+00,
        -2.177985376072406609e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        -5.583638046685115430e-01, 0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        0.000000000000000000e+00,  5.019801758935558134e-01,
        0.000000000000000000e+00,  3.822357359135244437e-01,
        1.749643220520866738e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
        3.790225991247342385e-01,  0.000000000000000000e+00,
        0.000000000000000000e+00,  0.000000000000000000e+00,
    };

    auto generator = [](auto *sd) {
        auto data = sd->candidate.data();
        for (uint32_t i = gpu::threadid();
             i < BitVector::requiredLength(sd->len_data);
             i += gpu::nthreads()) {
            data[i] = i;
        }
    };
    Qubo qubo(fromDense<float, gpu::GPUMem>(dense, num_rows), num_blocks,
              num_blocks, generator);
    qubo.search();

    std::printf("%f\n", qubo.getMinimum());
}

void testAgainstNumpyReference() {
    std::printf("Testing search against numpy reference on GPU\n");
    auto getLines = [](std::istream &input) {
        std::vector<std::vector<std::string>> lines;

        for (std::string line; std::getline(input, line);) {
            std::vector<std::string> result;
            std::stringstream lineStream(line);

            for (std::string cell; std::getline(lineStream, cell, ',');) {
                result.push_back(cell);
            }
            lines.push_back(result);
        }

        return lines;
    };

    auto readFileToVector = [&getLines](const std::string &fname) {
        if (std::ifstream is{fname}) {
            return getLines(is);
        } else {
            std::printf("Failed to open file '%s'\n", fname.c_str());
        }
        assert(false);
    };

    auto packBits = [](auto line) {
        std::vector<uint32_t> values;
        auto val = 0;
        auto i = 0;
        for (auto str : line) {
            val |= std::stoul(str) << (31 - i++);
            if (32 == i) {
                values.push_back(val);
                val = 0;
                i = 0;
            }
        }

        if (0 != i) {
            values.push_back(val);
        }

        return values;
    };

    std::printf("\tReading input files...\n");
    auto lines = readFileToVector(std::string("data/candidates.csv"));

    std::vector<std::vector<uint32_t>> candidates;
    candidates.reserve(lines.size());
    for (auto line : lines) {
        candidates.push_back(packBits(line));
    }

    lines = readFileToVector(std::string("data/sparse_matrix.csv"));
    assert(3 == lines.size());

    std::vector<uint32_t> indptr;
    for (auto str : lines[0]) {
        indptr.push_back(std::stoul(str));
    }

    std::vector<uint32_t> indices;
    for (auto str : lines[1]) {
        indices.push_back(std::stoul(str));
    }

    std::vector<float> data;
    for (auto str : lines[2]) {
        data.push_back(std::stof(str));
    }

    lines = readFileToVector(std::string("data/minimum.csv"));
    assert(2 == lines.size());
    auto numpy_min_cand = packBits(lines[0]);
    assert(numpy_min_cand.size() == candidates[0].size());

    auto numpy_min_val = std::stof(lines[1][0]);

    // For the generator: copy candidates to GPU and pack in superspan
    using S = SuperSpan<uint32_t>;
    auto memreq = S::memReq(candidates.size(), candidates[0].size());
    std::unique_ptr<uint32_t, decltype(&gpu::free)> mem(
        static_cast<uint32_t *>(gpu::allocate(memreq)), gpu::free);
    S h_sspan(std::span(mem.get(), memreq / sizeof(uint32_t)),
              candidates.size(), candidates[0].size());
    for (auto i = 0; i < candidates.size(); i++) {
        auto c = candidates[i];
        gpu::memcpy(h_sspan.subspan(i).data(), c.data(),
                    sizeof(uint32_t) * c.size());
    }

    // Allocate space for a SuperSpan in global memory
    std::unique_ptr<S, decltype(&gpu::free)> d_ssup(
        static_cast<S *>(gpu::allocate(sizeof(S))), gpu::free);
    S *d_ssp = d_ssup.get();
    // Copy the host superspan to device global memory
    gpu::memcpy(d_ssp, &h_sspan, sizeof(S));

    constexpr static size_t num_blocks = 1024ull;
    std::unique_ptr<uint32_t, decltype(&gpu::free)> d_siup(
        static_cast<uint32_t *>(gpu::allocate(sizeof(uint32_t) * num_blocks)),
        gpu::free);
    uint32_t *d_sip = d_siup.get();
    gpu::memset(d_sip, 0, sizeof(uint32_t) * num_blocks);

    // Finally we can make a generator that takes out values from the super span
    // for each block
    auto generator = [d_ssp, d_sip](auto *sd) {
        if (0 == gpu::threadid()) {
            atomicAdd(&d_sip[gpu::blockid()], 1u);
        }
        gpu::syncthreads();

        auto span = d_ssp->subspan(
            (d_sip[gpu::blockid()] - 1) * gpu::nblocks() + gpu::blockid());
        auto data = sd->candidate.data();
        for (uint32_t i = gpu::threadid(); i < span.size();
             i += gpu::nthreads()) {
            data[i] = span[i];
        }

        gpu::syncthreads();
    };

    std::printf("\tSearching...\n");
    Qubo qubo(SparseMatrix<float, gpu::GPUMem>(indptr, indices, data),
              num_blocks, candidates.size(), generator);
    qubo.search();

    std::printf("minimum: %f, reference minimum: %f\n", qubo.getMinimum(),
                numpy_min_val);
    assert(abs(qubo.getMinimum() - numpy_min_val) < 1e-6);

    auto sips = std::vector<uint32_t>(num_blocks, 0);
    gpu::memcpy(sips.data(), d_sip, sizeof(uint32_t) * sips.size());
    const auto sum = std::reduce(sips.begin(), sips.end());
    assert(sum == candidates.size());

    const auto bc = qubo.getCandidate();
    for (auto i = 0; i < numpy_min_cand.size(); i++) {
        assert(numpy_min_cand[i] == bc[i]);
    }
}
} // namespace testing

int main() {
    testing::testAllocator();
    testing::testSearchDataWithRows();
    testing::testSearchDataWithoutRows();
    testing::testFromToDense();
    testing::testBitVector();
    testing::testSuperspan();
    testing::testSuperspan2();
    testing::testmx1();
    testing::testmx2();
    testing::testBlockDotProduct1();
    testing::testBlockDotProduct2();
    testing::testMinimumRow();
    testing::testUpdateXY();
    testing::testSwapping();
    testing::testBlockSearch();
    testing::testSearch();
    testing::testSparseMatrix();
    testing::testWarpReduction();
    testing::testWarpArgSearch();
    testing::testGPUSearch();
    testing::testAgainstNumpyReference();

    gpu::synchronize();

    return 0;
}
